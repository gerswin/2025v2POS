version: '3.8'

services:
  # PostgreSQL Database
  db:
    image: docker.io/library/postgres:15-alpine
    container_name: tiquemax_db
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DB_NAME:-tiquemax_pos}
      POSTGRES_USER: ${DB_USER:-tiquemax}
      POSTGRES_PASSWORD: ${DB_PASSWORD:?Database password required}
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --locale=es_VE.UTF-8"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backups:/backups
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "${DB_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-tiquemax} -d ${DB_NAME:-tiquemax_pos}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - tiquemax_network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Redis Cache and Message Broker
  redis:
    image: docker.io/library/redis:7-alpine
    container_name: tiquemax_redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD:?Redis password required} --maxmemory 256mb --maxmemory-policy allkeys-lru --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "${REDIS_PORT:-6379}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - tiquemax_network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Django Web Application
  web:
    build:
      context: .
      dockerfile: Dockerfile.prod
      args:
        - PYTHON_VERSION=3.11
    image: tiquemax_web:latest
    container_name: tiquemax_web
    restart: unless-stopped
    command: >
      sh -c "
        python manage.py migrate --noinput &&
        python manage.py collectstatic --noinput &&
        gunicorn --config gunicorn.conf.py venezuelan_pos.wsgi:application
      "
    environment:
      # Django Settings
      - DJANGO_SETTINGS_MODULE=venezuelan_pos.settings
      - DEBUG=${DEBUG:-False}
      - SECRET_KEY=${SECRET_KEY:?Secret key required}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-localhost,127.0.0.1}

      # Database
      - DB_ENGINE=django.db.backends.postgresql
      - DB_NAME=${DB_NAME:-tiquemax_pos}
      - DB_USER=${DB_USER:-tiquemax}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_HOST=db
      - DB_PORT=5432

      # Redis
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - REDIS_CACHE_URL=redis://:${REDIS_PASSWORD}@redis:6379/1
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD}@redis:6379/2
      - CELERY_RESULT_BACKEND=redis://:${REDIS_PASSWORD}@redis:6379/3

      # Email
      - EMAIL_BACKEND=${EMAIL_BACKEND:-django.core.mail.backends.console.EmailBackend}
      - EMAIL_HOST=${EMAIL_HOST:-smtp.gmail.com}
      - EMAIL_PORT=${EMAIL_PORT:-587}
      - EMAIL_USE_TLS=${EMAIL_USE_TLS:-True}
      - EMAIL_HOST_USER=${EMAIL_HOST_USER}
      - EMAIL_HOST_PASSWORD=${EMAIL_HOST_PASSWORD}

      # Security
      - SECURE_SSL_REDIRECT=${SECURE_SSL_REDIRECT:-False}
      - SECURE_HSTS_SECONDS=${SECURE_HSTS_SECONDS:-0}
      - SESSION_COOKIE_SECURE=${SESSION_COOKIE_SECURE:-False}
      - CSRF_COOKIE_SECURE=${CSRF_COOKIE_SECURE:-False}

      # Application
      - DEFAULT_CURRENCY=USD
      - DEFAULT_LANGUAGE=es
      - TIME_ZONE=America/Caracas

    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy

    volumes:
      - static_volume:/app/staticfiles
      - media_volume:/app/media
      - logs_volume:/app/logs

    expose:
      - "8000"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    networks:
      - tiquemax_network

    labels:
      # Enable Traefik for this service
      - "traefik.enable=true"

      # HTTP Router
      - "traefik.http.routers.tiquemax-web.rule=Host(`${DOMAIN:-localhost}`)"
      - "traefik.http.routers.tiquemax-web.entrypoints=websecure"
      - "traefik.http.routers.tiquemax-web.tls.certresolver=letsencrypt"

      # Service
      - "traefik.http.services.tiquemax-web.loadbalancer.server.port=8000"

      # Middlewares
      - "traefik.http.routers.tiquemax-web.middlewares=security-headers,compress,rate-limit-general"

      # Static files route
      - "traefik.http.routers.tiquemax-static.rule=Host(`${DOMAIN:-localhost}`) && PathPrefix(`/static`)"
      - "traefik.http.routers.tiquemax-static.entrypoints=websecure"
      - "traefik.http.routers.tiquemax-static.tls.certresolver=letsencrypt"
      - "traefik.http.routers.tiquemax-static.middlewares=security-headers,compress"

      # Media files route
      - "traefik.http.routers.tiquemax-media.rule=Host(`${DOMAIN:-localhost}`) && PathPrefix(`/media`)"
      - "traefik.http.routers.tiquemax-media.entrypoints=websecure"
      - "traefik.http.routers.tiquemax-media.tls.certresolver=letsencrypt"
      - "traefik.http.routers.tiquemax-media.middlewares=security-headers"

      # Admin route with stricter rate limiting
      - "traefik.http.routers.tiquemax-admin.rule=Host(`${DOMAIN:-localhost}`) && PathPrefix(`/admin`)"
      - "traefik.http.routers.tiquemax-admin.entrypoints=websecure"
      - "traefik.http.routers.tiquemax-admin.tls.certresolver=letsencrypt"
      - "traefik.http.routers.tiquemax-admin.middlewares=security-headers,compress,rate-limit-admin"

      # API route with API rate limiting
      - "traefik.http.routers.tiquemax-api.rule=Host(`${DOMAIN:-localhost}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.tiquemax-api.entrypoints=websecure"
      - "traefik.http.routers.tiquemax-api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.tiquemax-api.middlewares=security-headers,compress,rate-limit-api,cors-headers"

      # Auth endpoints with strictest rate limiting
      - "traefik.http.routers.tiquemax-auth.rule=Host(`${DOMAIN:-localhost}`) && PathPrefix(`/accounts/login`)"
      - "traefik.http.routers.tiquemax-auth.entrypoints=websecure"
      - "traefik.http.routers.tiquemax-auth.tls.certresolver=letsencrypt"
      - "traefik.http.routers.tiquemax-auth.middlewares=security-headers,compress,rate-limit-auth"

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Celery Worker
  celery_worker:
    image: tiquemax_web:latest
    container_name: tiquemax_celery_worker
    restart: unless-stopped
    command: celery -A venezuelan_pos worker -l info --concurrency=4 --max-tasks-per-child=100
    environment:
      - DJANGO_SETTINGS_MODULE=venezuelan_pos.settings
      - DEBUG=${DEBUG:-False}
      - SECRET_KEY=${SECRET_KEY}
      - DB_ENGINE=django.db.backends.postgresql
      - DB_NAME=${DB_NAME:-tiquemax_pos}
      - DB_USER=${DB_USER:-tiquemax}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_HOST=db
      - DB_PORT=5432
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD}@redis:6379/2
      - CELERY_RESULT_BACKEND=redis://:${REDIS_PASSWORD}@redis:6379/3

    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      web:
        condition: service_healthy

    volumes:
      - media_volume:/app/media
      - logs_volume:/app/logs

    networks:
      - tiquemax_network

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Celery Beat Scheduler
  celery_beat:
    image: tiquemax_web:latest
    container_name: tiquemax_celery_beat
    restart: unless-stopped
    command: celery -A venezuelan_pos beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler
    environment:
      - DJANGO_SETTINGS_MODULE=venezuelan_pos.settings
      - DEBUG=${DEBUG:-False}
      - SECRET_KEY=${SECRET_KEY}
      - DB_ENGINE=django.db.backends.postgresql
      - DB_NAME=${DB_NAME:-tiquemax_pos}
      - DB_USER=${DB_USER:-tiquemax}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_HOST=db
      - DB_PORT=5432
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD}@redis:6379/2
      - CELERY_RESULT_BACKEND=redis://:${REDIS_PASSWORD}@redis:6379/3

    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      web:
        condition: service_healthy

    volumes:
      - logs_volume:/app/logs

    networks:
      - tiquemax_network

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Flower - Celery Monitoring
  flower:
    image: tiquemax_web:latest
    container_name: tiquemax_flower
    restart: unless-stopped
    command: celery -A venezuelan_pos flower --port=5555
    environment:
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD}@redis:6379/2
      - CELERY_RESULT_BACKEND=redis://:${REDIS_PASSWORD}@redis:6379/3
      - FLOWER_BASIC_AUTH=${FLOWER_USER:-admin}:${FLOWER_PASSWORD:?Flower password required}

    depends_on:
      - redis
      - celery_worker

    expose:
      - "5555"

    networks:
      - tiquemax_network

    labels:
      # Enable Traefik for this service
      - "traefik.enable=true"

      # HTTP Router for Flower
      - "traefik.http.routers.tiquemax-flower.rule=Host(`${DOMAIN:-localhost}`) && PathPrefix(`/flower`)"
      - "traefik.http.routers.tiquemax-flower.entrypoints=websecure"
      - "traefik.http.routers.tiquemax-flower.tls.certresolver=letsencrypt"

      # Service
      - "traefik.http.services.tiquemax-flower.loadbalancer.server.port=5555"

      # Middlewares - Add basic auth protection through Traefik as well
      - "traefik.http.routers.tiquemax-flower.middlewares=security-headers,compress,rate-limit-general"

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Traefik Reverse Proxy
  traefik:
    image: docker.io/library/traefik:v2.11
    container_name: tiquemax_traefik
    restart: unless-stopped

    command:
      # Enable Docker provider
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=tiquemax_network"

      # Enable file provider for dynamic configuration
      - "--providers.file.filename=/etc/traefik/dynamic.yml"
      - "--providers.file.watch=true"

      # Entry points
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.websecure.address=:443"

      # Let's Encrypt configuration
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL:-admin@${DOMAIN:-localhost}}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"

      # API and Dashboard
      - "--api.dashboard=true"
      - "--api.insecure=false"

      # Logging
      - "--log.level=${TRAEFIK_LOG_LEVEL:-INFO}"
      - "--log.format=json"
      - "--accesslog=true"
      - "--accesslog.format=json"
      - "--accesslog.filepath=/var/log/traefik/access.log"

      # Metrics
      - "--metrics.prometheus=true"

    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"

    volumes:
      # Docker socket for auto-discovery
      - /var/run/docker.sock:/var/run/docker.sock:ro

      # Configuration files
      - ./docker/traefik/dynamic.yml:/etc/traefik/dynamic.yml:ro

      # Let's Encrypt certificates storage
      - letsencrypt_data:/letsencrypt

      # Logs
      - traefik_logs:/var/log/traefik

      # Static and media files (served directly by Traefik)
      - static_volume:/var/www/static:ro
      - media_volume:/var/www/media:ro

    environment:
      - DOMAIN=${DOMAIN:-localhost}
      - ACME_EMAIL=${ACME_EMAIL:-admin@localhost}

    depends_on:
      web:
        condition: service_healthy

    networks:
      - tiquemax_network

    labels:
      # Enable Traefik for itself (dashboard)
      - "traefik.enable=true"

      # Dashboard router
      - "traefik.http.routers.traefik-dashboard.rule=Host(`${DOMAIN:-localhost}`) && (PathPrefix(`/dashboard`) || PathPrefix(`/api`))"
      - "traefik.http.routers.traefik-dashboard.entrypoints=websecure"
      - "traefik.http.routers.traefik-dashboard.tls.certresolver=letsencrypt"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"
      - "traefik.http.routers.traefik-dashboard.middlewares=dashboard-auth,security-headers"

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  tiquemax_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  static_volume:
    driver: local
  media_volume:
    driver: local
  logs_volume:
    driver: local
  traefik_logs:
    driver: local
  letsencrypt_data:
    driver: local
