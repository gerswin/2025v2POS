{% extends 'events/base.html' %}
{% load i18n static %}

{% block title %}{{ zone.name }} - {% trans "Seat Management" %}{% endblock %}

{% block extra_css %}
<style>
.seat-map {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 20px;
    overflow-x: auto;
}

.seat-row {
    display: flex;
    justify-content: center;
    margin-bottom: 10px;
    align-items: center;
}

.row-label {
    width: 40px;
    text-align: center;
    font-weight: bold;
    color: #6c757d;
    margin-right: 10px;
}

.seat {
    width: 35px;
    height: 35px;
    margin: 2px;
    border: 2px solid #dee2e6;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}

.seat.available {
    background-color: #d4edda;
    border-color: #28a745;
    color: #155724;
}

.seat.available:hover {
    background-color: #c3e6cb;
    transform: scale(1.1);
}

.seat.reserved {
    background-color: #fff3cd;
    border-color: #ffc107;
    color: #856404;
}

.seat.sold {
    background-color: #f8d7da;
    border-color: #dc3545;
    color: #721c24;
}

.seat.blocked {
    background-color: #e2e3e5;
    border-color: #6c757d;
    color: #495057;
}

.seat.selected {
    background-color: #cce5ff;
    border-color: #007bff;
    color: #004085;
    transform: scale(1.1);
}

.seat-legend {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.legend-seat {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    border: 2px solid;
}

.stage {
    background: linear-gradient(135deg, #6c757d, #495057);
    color: white;
    text-align: center;
    padding: 15px;
    margin-bottom: 30px;
    border-radius: 0.375rem;
    font-weight: bold;
    position: relative;
}

.stage::before {
    content: '';
    position: absolute;
    bottom: -10px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 10px solid transparent;
    border-right: 10px solid transparent;
    border-top: 10px solid #495057;
}

.table-container {
    border: 2px dashed #007bff;
    border-radius: 8px;
    padding: 10px;
    margin: 5px;
    background-color: rgba(0, 123, 255, 0.1);
    position: relative;
}

.table-label {
    position: absolute;
    top: -12px;
    left: 10px;
    background: #007bff;
    color: white;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">{% trans "Seat Management" %}</h1>
                    <p class="text-muted mb-0">{{ zone.name }} - {{ zone.event.name }}</p>
                </div>
                <div>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTableModal">
                        <i class="fas fa-plus"></i> {% trans "Create Table" %}
                    </button>
                    <button class="btn btn-outline-info" onclick="toggleTableView()">
                        <i class="fas fa-table"></i> <span id="tableViewToggle">{% trans "Show Tables" %}</span>
                    </button>
                    <a href="{% url 'events:event_detail' zone.event.id %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> {% trans "Back to Event" %}
                    </a>
                </div>
            </div>

            <!-- Zone Info -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2">
                            <div class="small text-muted">{% trans "Zone Type" %}</div>
                            <div class="fw-bold">
                                <i class="fas fa-chair"></i> {% trans "Numbered Seating" %}
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="small text-muted">{% trans "Total Capacity" %}</div>
                            <div class="fw-bold">{{ zone.capacity }}</div>
                        </div>
                        <div class="col-md-2">
                            <div class="small text-muted">{% trans "Available" %}</div>
                            <div class="fw-bold text-success" id="availableCount">-</div>
                        </div>
                        <div class="col-md-2">
                            <div class="small text-muted">{% trans "Reserved" %}</div>
                            <div class="fw-bold text-warning" id="reservedCount">-</div>
                        </div>
                        <div class="col-md-2">
                            <div class="small text-muted">{% trans "Sold" %}</div>
                            <div class="fw-bold text-danger" id="soldCount">-</div>
                        </div>
                        <div class="col-md-2">
                            <div class="small text-muted">{% trans "Base Price" %}</div>
                            <div class="fw-bold">${{ zone.base_price }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seat Management Tools -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tools"></i> {% trans "Management Tools" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">{% trans "Bulk Actions" %}</label>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-success" onclick="bulkUpdateStatus('available')">
                                        <i class="fas fa-check"></i> {% trans "Make Available" %}
                                    </button>
                                    <button type="button" class="btn btn-outline-warning" onclick="bulkUpdateStatus('reserved')">
                                        <i class="fas fa-clock"></i> {% trans "Reserve" %}
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="bulkUpdateStatus('blocked')">
                                        <i class="fas fa-ban"></i> {% trans "Block" %}
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">{% trans "Selection Tools" %}</label>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-primary" onclick="selectAll()">
                                        <i class="fas fa-check-square"></i> {% trans "Select All" %}
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="clearSelection()">
                                        <i class="fas fa-square"></i> {% trans "Clear Selection" %}
                                    </button>
                                    <button type="button" class="btn btn-outline-info" onclick="selectRow()">
                                        <i class="fas fa-arrows-alt-h"></i> {% trans "Select Row" %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle"></i>
                                <strong>{% trans "Selected seats:" %}</strong> <span id="selectedCount">0</span> |
                                <strong>{% trans "Instructions:" %}</strong> {% trans "Click seats to select them, then use bulk actions above." %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seat Map -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-map"></i> {% trans "Seat Map" %}
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Legend -->
                    <div class="seat-legend">
                        <div class="legend-item">
                            <div class="legend-seat available" style="background-color: #d4edda; border-color: #28a745;"></div>
                            <span>{% trans "Available" %}</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-seat reserved" style="background-color: #fff3cd; border-color: #ffc107;"></div>
                            <span>{% trans "Reserved" %}</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-seat sold" style="background-color: #f8d7da; border-color: #dc3545;"></div>
                            <span>{% trans "Sold" %}</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-seat blocked" style="background-color: #e2e3e5; border-color: #6c757d;"></div>
                            <span>{% trans "Blocked" %}</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-seat selected" style="background-color: #cce5ff; border-color: #007bff;"></div>
                            <span>{% trans "Selected" %}</span>
                        </div>
                    </div>

                    <!-- Stage -->
                    <div class="stage">
                        <i class="fas fa-music"></i> {% trans "STAGE" %}
                    </div>

                    <!-- Seat Map Container -->
                    <div class="seat-map" id="seatMap">
                        <div class="text-center py-5">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">{% trans "Loading seats..." %}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Table Modal -->
<div class="modal fade" id="createTableModal" tabindex="-1" aria-labelledby="createTableModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createTableModalLabel">
                    <i class="fas fa-plus"></i> {% trans "Create Table" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
            </div>
            <form id="createTableForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="tableName" class="form-label">{% trans "Table Name" %} <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="tableName" name="name" required>
                    </div>

                    <div class="mb-3">
                        <label for="tableDescription" class="form-label">{% trans "Description" %}</label>
                        <textarea class="form-control" id="tableDescription" name="description" rows="2"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="saleMode" class="form-label">{% trans "Sale Mode" %}</label>
                        <select class="form-select" id="saleMode" name="sale_mode">
                            <option value="individual_allowed">{% trans "Individual Seats Allowed" %}</option>
                            <option value="complete_only">{% trans "Complete Table Only" %}</option>
                        </select>
                        <div class="form-text">
                            {% trans "Complete table only means all seats must be purchased together." %}
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        {% trans "After creating the table, select seats on the map and assign them to this table." %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> {% trans "Create Table" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Seat Details Modal -->
<div class="modal fade" id="seatDetailsModal" tabindex="-1" aria-labelledby="seatDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="seatDetailsModalLabel">
                    <i class="fas fa-chair"></i> {% trans "Seat Details" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
            </div>
            <div class="modal-body" id="seatDetailsContent">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button>
                <button type="button" class="btn btn-primary" id="saveSeatChanges">
                    <i class="fas fa-save"></i> {% trans "Save Changes" %}
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const zoneId = '{{ zone.id }}';
let seats = [];
let tables = [];
let selectedSeats = new Set();
let showTables = false;

document.addEventListener('DOMContentLoaded', function() {
    loadSeats();
    loadTables();
    setupCreateTableForm();
});

function loadSeats() {
    console.log('Loading seats for zone:', zoneId);
    loadAllSeats(`/api/v1/api/seats/?zone=${zoneId}`);
}

function loadAllSeats(url, allSeats = []) {
    fetch(url)
        .then(response => {
            console.log('Seats API response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Seats page received:', data);
            
            // Add current page results to all seats
            const currentSeats = data.results || [];
            allSeats = allSeats.concat(currentSeats);
            
            console.log(`Loaded ${currentSeats.length} seats from this page. Total so far: ${allSeats.length}`);
            
            // If there's a next page, load it recursively
            if (data.next) {
                console.log('Loading next page:', data.next);
                loadAllSeats(data.next, allSeats);
            } else {
                // All pages loaded, now render
                seats = allSeats;
                console.log('All seats loaded. Total:', seats.length);
                renderSeatMap();
                updateCounts();
            }
        })
        .catch(error => {
            console.error('Error loading seats:', error);
            document.getElementById('seatMap').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    {% trans "Error loading seats. Please refresh the page." %}
                </div>
            `;
        });
}

function loadTables() {
    fetch(`/api/v1/api/tables/?zone=${zoneId}`)
        .then(response => response.json())
        .then(data => {
            tables = data.results || [];
        })
        .catch(error => {
            console.error('Error loading tables:', error);
        });
}

function renderSeatMap() {
    const seatMap = document.getElementById('seatMap');
    
    if (seats.length === 0) {
        seatMap.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-chair fa-4x text-muted mb-4"></i>
                <h5 class="text-muted">{% trans "No Seats Found" %}</h5>
                <p class="text-muted">{% trans "Seats should be automatically generated for numbered zones." %}</p>
            </div>
        `;
        return;
    }

    console.log('Rendering seat map with', seats.length, 'seats');

    // Group seats by row
    const seatsByRow = {};
    seats.forEach(seat => {
        if (!seatsByRow[seat.row_number]) {
            seatsByRow[seat.row_number] = [];
        }
        seatsByRow[seat.row_number].push(seat);
    });

    console.log('Seats grouped by row:', seatsByRow);

    // Sort rows and seats
    const sortedRows = Object.keys(seatsByRow).sort((a, b) => parseInt(a) - parseInt(b));
    console.log('Sorted rows:', sortedRows);
    
    let html = '';
    sortedRows.forEach(rowNumber => {
        const rowSeats = seatsByRow[rowNumber].sort((a, b) => a.seat_number - b.seat_number);
        console.log(`Row ${rowNumber} has ${rowSeats.length} seats`);
        
        html += `<div class="seat-row">`;
        html += `<div class="row-label">R${rowNumber}</div>`;
        
        rowSeats.forEach(seat => {
            const isSelected = selectedSeats.has(seat.id);
            const seatClass = isSelected ? 'selected' : seat.status;
            
            html += `
                <div class="seat ${seatClass}" 
                     data-seat-id="${seat.id}"
                     data-row="${seat.row_number}"
                     data-seat="${seat.seat_number}"
                     onclick="toggleSeat('${seat.id}')"
                     oncontextmenu="showSeatDetails('${seat.id}'); return false;"
                     title="Row ${seat.row_number}, Seat ${seat.seat_number} - ${seat.status}${seat.calculated_price ? ' - $' + parseFloat(seat.calculated_price).toFixed(2) : ''}">
                    ${seat.seat_number}
                </div>
            `;
        });
        
        html += `</div>`;
    });

    console.log('Generated HTML length:', html.length);
    seatMap.innerHTML = html;
}

function toggleSeat(seatId) {
    if (selectedSeats.has(seatId)) {
        selectedSeats.delete(seatId);
    } else {
        selectedSeats.add(seatId);
    }
    
    renderSeatMap();
    updateSelectedCount();
}

function updateSelectedCount() {
    const element = document.getElementById('selectedCount');
    if (element) {
        element.textContent = selectedSeats.size;
    }
}

function updateCounts() {
    const counts = {
        available: 0,
        reserved: 0,
        sold: 0,
        blocked: 0
    };

    seats.forEach(seat => {
        if (counts.hasOwnProperty(seat.status)) {
            counts[seat.status]++;
        }
    });

    const availableElement = document.getElementById('availableCount');
    const reservedElement = document.getElementById('reservedCount');
    const soldElement = document.getElementById('soldCount');
    
    if (availableElement) availableElement.textContent = counts.available;
    if (reservedElement) reservedElement.textContent = counts.reserved;
    if (soldElement) soldElement.textContent = counts.sold;
}

function selectAll() {
    selectedSeats.clear();
    seats.forEach(seat => {
        if (seat.status !== 'sold') { // Don't select sold seats
            selectedSeats.add(seat.id);
        }
    });
    renderSeatMap();
    updateSelectedCount();
}

function clearSelection() {
    selectedSeats.clear();
    renderSeatMap();
    updateSelectedCount();
}

function selectRow() {
    const rowNumber = prompt('{% trans "Enter row number to select:" %}');
    if (rowNumber) {
        selectedSeats.clear();
        seats.forEach(seat => {
            if (seat.row_number == rowNumber && seat.status !== 'sold') {
                selectedSeats.add(seat.id);
            }
        });
        renderSeatMap();
        updateSelectedCount();
    }
}

function bulkUpdateStatus(newStatus) {
    if (selectedSeats.size === 0) {
        alert('{% trans "Please select seats first" %}');
        return;
    }

    if (confirm('{% trans "Update" %} ' + selectedSeats.size + ' {% trans "selected seats to" %} ' + newStatus + '?')) {
        const promises = Array.from(selectedSeats).map(seatId => {
            return fetch(`/api/v1/api/seats/${seatId}/update_status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ status: newStatus })
            });
        });

        Promise.all(promises)
            .then(responses => {
                const successCount = responses.filter(r => r.ok).length;
                showAlert('success', '{% trans "Updated" %} ' + successCount + ' {% trans "seats successfully" %}');
                selectedSeats.clear();
                loadSeats();
            })
            .catch(error => {
                console.error('Error updating seats:', error);
                showAlert('danger', '{% trans "Error updating seats" %}');
            });
    }
}

function showSeatDetails(seatId) {
    const seat = seats.find(s => s.id === seatId);
    if (!seat) return;

    const content = `
        <div class="row">
            <div class="col-md-6">
                <h6>{% trans "Position" %}</h6>
                <p>{% trans "Row" %} ${seat.row_number}, {% trans "Seat" %} ${seat.seat_number}</p>

                <h6>{% trans "Status" %}</h6>
                <select class="form-select" id="seatStatus">
                    <option value="available" ${seat.status === 'available' ? 'selected' : ''}>{% trans "Available" %}</option>
                    <option value="reserved" ${seat.status === 'reserved' ? 'selected' : ''}>{% trans "Reserved" %}</option>
                    <option value="sold" ${seat.status === 'sold' ? 'selected' : ''}>{% trans "Sold" %}</option>
                    <option value="blocked" ${seat.status === 'blocked' ? 'selected' : ''}>{% trans "Blocked" %}</option>
                </select>
            </div>
            <div class="col-md-6">
                <h6>{% trans "Price Modifier (%)" %}</h6>
                <input type="number" class="form-control" id="priceModifier"
                       value="${seat.price_modifier}" step="0.01">

                <h6 class="mt-3">{% trans "Final Price" %}</h6>
                <p class="fw-bold">$${parseFloat(seat.calculated_price || 0).toFixed(2)}</p>
            </div>
        </div>
    `;

    document.getElementById('seatDetailsContent').innerHTML = content;
    document.getElementById('saveSeatChanges').onclick = () => saveSeatChanges(seatId);
    
    const modal = new bootstrap.Modal(document.getElementById('seatDetailsModal'));
    modal.show();
}

function saveSeatChanges(seatId) {
    const status = document.getElementById('seatStatus').value;
    const priceModifier = document.getElementById('priceModifier').value;

    fetch(`/api/v1/api/seats/${seatId}/`, {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            status: status,
            price_modifier: priceModifier
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            bootstrap.Modal.getInstance(document.getElementById('seatDetailsModal')).hide();
            loadSeats();
            showAlert('success', '{% trans "Seat updated successfully" %}');
        } else {
            showAlert('danger', '{% trans "Error updating seat" %}');
        }
    })
    .catch(error => {
        console.error('Error updating seat:', error);
        showAlert('danger', '{% trans "Error updating seat" %}');
    });
}

function setupCreateTableForm() {
    const form = document.getElementById('createTableForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            createTable();
        });
    }
}

function createTable() {
    const form = document.getElementById('createTableForm');
    const formData = new FormData(form);
    
    const data = {
        zone: zoneId,
        name: formData.get('name'),
        description: formData.get('description'),
        sale_mode: formData.get('sale_mode')
    };

    fetch('/api/v1/api/tables/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            bootstrap.Modal.getInstance(document.getElementById('createTableModal')).hide();
            form.reset();
            loadTables();
            showAlert('success', '{% trans "Table created successfully!" %}');
        } else {
            showAlert('danger', '{% trans "Error creating table:" %} ' + JSON.stringify(data));
        }
    })
    .catch(error => {
        console.error('Error creating table:', error);
        showAlert('danger', '{% trans "Error creating table" %}');
    });
}

function toggleTableView() {
    showTables = !showTables;
    const toggleElement = document.getElementById('tableViewToggle');
    if (toggleElement) {
        toggleElement.textContent = showTables ? '{% trans "Hide Tables" %}' : '{% trans "Show Tables" %}';
    }
    renderSeatMap();
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container-fluid');
    if (container) {
        container.insertBefore(alertDiv, container.firstChild);
        
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Fix accessibility issues with modals
document.addEventListener('DOMContentLoaded', function() {
    // Handle modal focus issues
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        modal.addEventListener('hidden.bs.modal', function() {
            // Remove focus from any buttons inside the modal
            const focusedElement = this.querySelector(':focus');
            if (focusedElement) {
                focusedElement.blur();
            }
        });
    });
});
</script>
{% endblock %}