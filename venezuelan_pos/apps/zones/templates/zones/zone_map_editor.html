{% extends 'events/base.html' %}
{% load static %}

{% block title %}Zone Map Editor - {{ event.name }}{% endblock %}

{% block extra_css %}
<style>
.map-editor-container {
    position: relative;
    width: 100%;
    height: 80vh;
    border: 2px solid #dee2e6;
    border-radius: 0.375rem;
    background: #f8f9fa;
    overflow: hidden;
    background-image: 
        linear-gradient(rgba(0,0,0,.1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,0,0,.1) 1px, transparent 1px);
    background-size: 20px 20px;
}

.venue-map {
    position: relative;
    width: 100%;
    height: 100%;
    cursor: grab;
}

.venue-map.dragging {
    cursor: grabbing;
}

.zone-element {
    position: absolute;
    border: 2px solid #007bff;
    border-radius: 8px;
    background: rgba(0, 123, 255, 0.1);
    cursor: move;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: #004085;
    user-select: none;
    transition: all 0.2s ease;
    min-width: 80px;
    min-height: 60px;
}

.zone-element:hover {
    background: rgba(0, 123, 255, 0.2);
    border-color: #0056b3;
    transform: scale(1.02);
    z-index: 10;
}

.zone-element.selected {
    border-color: #28a745;
    background: rgba(40, 167, 69, 0.2);
    box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.3);
    z-index: 15;
}

.zone-element.dragging {
    opacity: 0.8;
    transform: rotate(2deg);
    z-index: 20;
}

.zone-label {
    text-align: center;
    font-size: 12px;
    line-height: 1.2;
    padding: 4px;
}

.zone-info {
    font-size: 10px;
    opacity: 0.8;
}

.toolbar {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 15px;
    margin-bottom: 20px;
}

.zone-list {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    background: white;
}

.zone-list-item {
    padding: 10px 15px;
    border-bottom: 1px solid #f1f3f4;
    cursor: pointer;
    display: flex;
    justify-content: between;
    align-items: center;
}

.zone-list-item:hover {
    background: #f8f9fa;
}

.zone-list-item.selected {
    background: #e3f2fd;
    border-left: 4px solid #2196f3;
}

.zone-stats {
    font-size: 12px;
    color: #6c757d;
}

.controls {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
}

.zoom-controls {
    display: flex;
    gap: 5px;
}

.position-info {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    padding: 8px 12px;
    font-size: 12px;
    font-family: monospace;
}

.stage-indicator {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #6c757d, #495057);
    color: white;
    padding: 10px 20px;
    border-radius: 0.375rem;
    font-weight: bold;
    z-index: 5;
}

.legend {
    display: flex;
    gap: 15px;
    align-items: center;
    font-size: 12px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
}

.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 3px;
    border: 1px solid #ccc;
}

.resize-handle {
    position: absolute;
    width: 8px;
    height: 8px;
    background: #007bff;
    border: 1px solid white;
    border-radius: 50%;
}

.resize-handle.nw { top: -4px; left: -4px; cursor: nw-resize; }
.resize-handle.ne { top: -4px; right: -4px; cursor: ne-resize; }
.resize-handle.sw { bottom: -4px; left: -4px; cursor: sw-resize; }
.resize-handle.se { bottom: -4px; right: -4px; cursor: se-resize; }

.zone-element.selected .resize-handle {
    display: block;
}

.zone-element .resize-handle {
    display: none;
}

@media (max-width: 768px) {
    .map-editor-container {
        height: 60vh;
    }
    
    .controls {
        flex-direction: column;
        align-items: stretch;
    }
    
    .zone-element {
        min-width: 60px;
        min-height: 40px;
        font-size: 10px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">Zone Map Editor</h1>
                    <p class="text-muted mb-0">{{ event.name }} - {{ venue.name }}</p>
                </div>
                <div>
                    <button class="btn btn-success" id="saveLayoutBtn">
                        <i class="fas fa-save"></i> Save Layout
                    </button>
                    <button class="btn btn-outline-secondary" id="resetLayoutBtn">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                    <a href="{% url 'events:event_detail' event.id %}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left"></i> Back to Event
                    </a>
                </div>
            </div>

            <!-- Toolbar -->
            <div class="toolbar">
                <div class="controls">
                    <div class="zoom-controls">
                        <button class="btn btn-sm btn-outline-secondary" id="zoomInBtn">
                            <i class="fas fa-search-plus"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" id="zoomOutBtn">
                            <i class="fas fa-search-minus"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" id="resetZoomBtn">
                            <i class="fas fa-expand-arrows-alt"></i>
                        </button>
                    </div>
                    
                    <div class="position-info" id="positionInfo">
                        Position: (0, 0) | Selected: None
                    </div>
                    
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: rgba(0, 123, 255, 0.1); border-color: #007bff;"></div>
                            <span>Zone</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: rgba(40, 167, 69, 0.2); border-color: #28a745;"></div>
                            <span>Selected</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Zone List -->
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-list"></i> Zones ({{ zones.count }})
                            </h5>
                        </div>
                        <div class="zone-list" id="zoneList">
                            {% for zone in zones %}
                            <div class="zone-list-item" data-zone-id="{{ zone.id }}">
                                <div>
                                    <div class="fw-bold">{{ zone.name }}</div>
                                    <div class="zone-stats">
                                        {{ zone.zone_type|title }} | {{ zone.capacity }} seats | ${{ zone.base_price }}
                                    </div>
                                </div>
                                <div class="text-end">
                                    <small class="text-muted">
                                        {% if zone.map_x and zone.map_y %}
                                            <i class="fas fa-map-marker-alt text-success"></i>
                                        {% else %}
                                            <i class="fas fa-map-marker-alt text-muted"></i>
                                        {% endif %}
                                    </small>
                                </div>
                            </div>
                            {% empty %}
                            <div class="p-3 text-center text-muted">
                                <i class="fas fa-info-circle"></i>
                                No zones found. Create zones first.
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Map Editor -->
                <div class="col-md-9">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-map"></i> Venue Layout
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="map-editor-container" id="mapContainer">
                                <div class="venue-map" id="venueMap">
                                    <!-- Stage indicator -->
                                    <div class="stage-indicator">
                                        <i class="fas fa-music"></i> STAGE
                                    </div>
                                    
                                    <!-- Zones will be rendered here -->
                                    {% for zone in zones %}
                                    <div class="zone-element" 
                                         id="zone-{{ zone.id }}"
                                         data-zone-id="{{ zone.id }}"
                                         data-zone-name="{{ zone.name }}"
                                         style="
                                            left: {{ zone.map_x|default:100 }}px;
                                            top: {{ zone.map_y|default:100 }}px;
                                            width: {{ zone.map_width|default:120 }}px;
                                            height: {{ zone.map_height|default:80 }}px;
                                            transform: rotate({{ zone.map_rotation|default:0 }}deg);
                                         ">
                                        <div class="zone-label">
                                            <div>{{ zone.name }}</div>
                                            <div class="zone-info">{{ zone.capacity }} seats</div>
                                        </div>
                                        
                                        <!-- Resize handles -->
                                        <div class="resize-handle nw"></div>
                                        <div class="resize-handle ne"></div>
                                        <div class="resize-handle sw"></div>
                                        <div class="resize-handle se"></div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Zone Properties Modal -->
<div class="modal fade" id="zonePropertiesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cog"></i> Zone Properties
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="zonePropertiesContent">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveZonePropertiesBtn">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const eventId = '{{ event.id }}';
let selectedZone = null;
let isDragging = false;
let isResizing = false;
let dragOffset = { x: 0, y: 0 };
let zoomLevel = 1;
let zones = {};

// Initialize zones data
{% for zone in zones %}
zones['{{ zone.id }}'] = {
    id: '{{ zone.id }}',
    name: '{{ zone.name }}',
    capacity: {{ zone.capacity }},
    zone_type: '{{ zone.zone_type }}',
    base_price: {{ zone.base_price }},
    x: {{ zone.map_x|default:100 }},
    y: {{ zone.map_y|default:100 }},
    width: {{ zone.map_width|default:120 }},
    height: {{ zone.map_height|default:80 }},
    rotation: {{ zone.map_rotation|default:0 }}
};
{% endfor %}

document.addEventListener('DOMContentLoaded', function() {
    initializeMapEditor();
});

function initializeMapEditor() {
    const venueMap = document.getElementById('venueMap');
    const mapContainer = document.getElementById('mapContainer');
    
    // Add event listeners for zone elements
    document.querySelectorAll('.zone-element').forEach(zoneElement => {
        addZoneEventListeners(zoneElement);
    });
    
    // Add event listeners for zone list items
    document.querySelectorAll('.zone-list-item').forEach(listItem => {
        const zoneId = listItem.dataset.zoneId;
        listItem.addEventListener('click', function(e) {
            e.stopPropagation();
            selectZone(zoneId);
        });
    });
    
    // Map container mouse events for position tracking
    mapContainer.addEventListener('mousemove', function(e) {
        const rect = mapContainer.getBoundingClientRect();
        const x = Math.round((e.clientX - rect.left) / zoomLevel);
        const y = Math.round((e.clientY - rect.top) / zoomLevel);
        
        const selectedText = selectedZone ? zones[selectedZone].name : 'None';
        document.getElementById('positionInfo').textContent = 
            `Position: (${x}, ${y}) | Selected: ${selectedText}`;
    });
    
    // Add event listeners for toolbar buttons
    document.getElementById('saveLayoutBtn').addEventListener('click', saveLayout);
    document.getElementById('resetLayoutBtn').addEventListener('click', resetLayout);
    document.getElementById('zoomInBtn').addEventListener('click', zoomIn);
    document.getElementById('zoomOutBtn').addEventListener('click', zoomOut);
    document.getElementById('resetZoomBtn').addEventListener('click', resetZoom);
    document.getElementById('saveZonePropertiesBtn').addEventListener('click', saveZoneProperties);
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Delete' && selectedZone) {
            // Could implement zone deletion here
        }
        if (e.key === 'Escape') {
            clearSelection();
        }
    });
}

function addZoneEventListeners(zoneElement) {
    const zoneId = zoneElement.dataset.zoneId;
    
    // Click to select
    zoneElement.addEventListener('click', function(e) {
        e.stopPropagation();
        selectZone(zoneId);
    });
    
    // Double click for properties
    zoneElement.addEventListener('dblclick', function(e) {
        e.stopPropagation();
        showZoneProperties(zoneId);
    });
    
    // Drag functionality
    zoneElement.addEventListener('mousedown', function(e) {
        if (e.target.classList.contains('resize-handle')) {
            startResize(e, zoneId);
        } else {
            startDrag(e, zoneId);
        }
    });
}

function selectZone(zoneId) {
    // Clear previous selection
    document.querySelectorAll('.zone-element').forEach(el => {
        el.classList.remove('selected');
    });
    document.querySelectorAll('.zone-list-item').forEach(el => {
        el.classList.remove('selected');
    });
    
    // Select new zone
    const zoneElement = document.getElementById(`zone-${zoneId}`);
    const listItem = document.querySelector(`[data-zone-id="${zoneId}"]`);
    
    if (zoneElement) {
        zoneElement.classList.add('selected');
        selectedZone = zoneId;
    }
    
    if (listItem) {
        listItem.classList.add('selected');
    }
}

function clearSelection() {
    document.querySelectorAll('.zone-element').forEach(el => {
        el.classList.remove('selected');
    });
    document.querySelectorAll('.zone-list-item').forEach(el => {
        el.classList.remove('selected');
    });
    selectedZone = null;
}

function startDrag(e, zoneId) {
    e.preventDefault();
    isDragging = true;
    selectZone(zoneId);
    
    const zoneElement = document.getElementById(`zone-${zoneId}`);
    const rect = zoneElement.getBoundingClientRect();
    const mapRect = document.getElementById('mapContainer').getBoundingClientRect();
    
    dragOffset.x = e.clientX - rect.left;
    dragOffset.y = e.clientY - rect.top;
    
    zoneElement.classList.add('dragging');
    document.body.style.cursor = 'grabbing';
    
    function onMouseMove(e) {
        if (!isDragging) return;
        
        const mapRect = document.getElementById('mapContainer').getBoundingClientRect();
        const x = (e.clientX - mapRect.left - dragOffset.x) / zoomLevel;
        const y = (e.clientY - mapRect.top - dragOffset.y) / zoomLevel;
        
        // Constrain to map bounds
        const constrainedX = Math.max(0, Math.min(x, mapRect.width / zoomLevel - zones[zoneId].width));
        const constrainedY = Math.max(0, Math.min(y, mapRect.height / zoomLevel - zones[zoneId].height));
        
        zoneElement.style.left = constrainedX + 'px';
        zoneElement.style.top = constrainedY + 'px';
        
        // Update zones data
        zones[zoneId].x = constrainedX;
        zones[zoneId].y = constrainedY;
    }
    
    function onMouseUp() {
        isDragging = false;
        zoneElement.classList.remove('dragging');
        document.body.style.cursor = '';
        
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
        
        // Save position
        updateZonePosition(zoneId);
    }
    
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
}

function startResize(e, zoneId) {
    e.preventDefault();
    e.stopPropagation();
    isResizing = true;
    
    const handle = e.target;
    const zoneElement = document.getElementById(`zone-${zoneId}`);
    const handleType = handle.classList[1]; // nw, ne, sw, se
    
    const startX = e.clientX;
    const startY = e.clientY;
    const startWidth = zones[zoneId].width;
    const startHeight = zones[zoneId].height;
    const startLeft = zones[zoneId].x;
    const startTop = zones[zoneId].y;
    
    function onMouseMove(e) {
        if (!isResizing) return;
        
        const deltaX = (e.clientX - startX) / zoomLevel;
        const deltaY = (e.clientY - startY) / zoomLevel;
        
        let newWidth = startWidth;
        let newHeight = startHeight;
        let newLeft = startLeft;
        let newTop = startTop;
        
        switch (handleType) {
            case 'se': // Southeast
                newWidth = Math.max(60, startWidth + deltaX);
                newHeight = Math.max(40, startHeight + deltaY);
                break;
            case 'sw': // Southwest
                newWidth = Math.max(60, startWidth - deltaX);
                newHeight = Math.max(40, startHeight + deltaY);
                newLeft = startLeft + (startWidth - newWidth);
                break;
            case 'ne': // Northeast
                newWidth = Math.max(60, startWidth + deltaX);
                newHeight = Math.max(40, startHeight - deltaY);
                newTop = startTop + (startHeight - newHeight);
                break;
            case 'nw': // Northwest
                newWidth = Math.max(60, startWidth - deltaX);
                newHeight = Math.max(40, startHeight - deltaY);
                newLeft = startLeft + (startWidth - newWidth);
                newTop = startTop + (startHeight - newHeight);
                break;
        }
        
        // Apply changes
        zoneElement.style.width = newWidth + 'px';
        zoneElement.style.height = newHeight + 'px';
        zoneElement.style.left = newLeft + 'px';
        zoneElement.style.top = newTop + 'px';
        
        // Update zones data
        zones[zoneId].width = newWidth;
        zones[zoneId].height = newHeight;
        zones[zoneId].x = newLeft;
        zones[zoneId].y = newTop;
    }
    
    function onMouseUp() {
        isResizing = false;
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
        
        // Save changes
        updateZonePosition(zoneId);
    }
    
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
}

function updateZonePosition(zoneId) {
    const zoneData = zones[zoneId];
    
    fetch(`/zones/zones/${zoneId}/update-position/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            x: zoneData.x,
            y: zoneData.y,
            width: zoneData.width,
            height: zoneData.height,
            rotation: zoneData.rotation
        })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            console.error('Error updating zone position:', data.error);
            showAlert('danger', 'Error updating zone position');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'Error updating zone position');
    });
}

function saveLayout() {
    const zonesArray = Object.values(zones);
    
    fetch(`/zones/events/${eventId}/save-layout/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            zones: zonesArray
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
        } else {
            showAlert('danger', 'Error saving layout: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'Error saving layout');
    });
}

function resetLayout() {
    if (confirm('Reset all zones to default positions? This cannot be undone.')) {
        // Reset all zones to default positions
        Object.keys(zones).forEach((zoneId, index) => {
            const zoneElement = document.getElementById(`zone-${zoneId}`);
            const defaultX = 100 + (index % 4) * 150;
            const defaultY = 100 + Math.floor(index / 4) * 100;
            
            zones[zoneId].x = defaultX;
            zones[zoneId].y = defaultY;
            zones[zoneId].width = 120;
            zones[zoneId].height = 80;
            zones[zoneId].rotation = 0;
            
            zoneElement.style.left = defaultX + 'px';
            zoneElement.style.top = defaultY + 'px';
            zoneElement.style.width = '120px';
            zoneElement.style.height = '80px';
            zoneElement.style.transform = 'rotate(0deg)';
        });
        
        saveLayout();
    }
}

function zoomIn() {
    zoomLevel = Math.min(zoomLevel * 1.2, 3);
    applyZoom();
}

function zoomOut() {
    zoomLevel = Math.max(zoomLevel / 1.2, 0.5);
    applyZoom();
}

function resetZoom() {
    zoomLevel = 1;
    applyZoom();
}

function applyZoom() {
    const venueMap = document.getElementById('venueMap');
    venueMap.style.transform = `scale(${zoomLevel})`;
    venueMap.style.transformOrigin = 'top left';
}

function showZoneProperties(zoneId) {
    const zone = zones[zoneId];
    const content = `
        <div class="row">
            <div class="col-md-6">
                <h6>Position</h6>
                <div class="mb-3">
                    <label class="form-label">X Position</label>
                    <input type="number" class="form-control" id="propX" value="${zone.x}" step="1">
                </div>
                <div class="mb-3">
                    <label class="form-label">Y Position</label>
                    <input type="number" class="form-control" id="propY" value="${zone.y}" step="1">
                </div>
            </div>
            <div class="col-md-6">
                <h6>Size</h6>
                <div class="mb-3">
                    <label class="form-label">Width</label>
                    <input type="number" class="form-control" id="propWidth" value="${zone.width}" step="1" min="60">
                </div>
                <div class="mb-3">
                    <label class="form-label">Height</label>
                    <input type="number" class="form-control" id="propHeight" value="${zone.height}" step="1" min="40">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="mb-3">
                    <label class="form-label">Rotation (degrees)</label>
                    <input type="number" class="form-control" id="propRotation" value="${zone.rotation}" step="1" min="-180" max="180">
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('zonePropertiesContent').innerHTML = content;
    document.querySelector('#zonePropertiesModal .modal-title').innerHTML = 
        `<i class="fas fa-cog"></i> ${zone.name} Properties`;
    
    const modal = new bootstrap.Modal(document.getElementById('zonePropertiesModal'));
    modal.show();
}

function saveZoneProperties() {
    if (!selectedZone) return;
    
    const x = parseFloat(document.getElementById('propX').value);
    const y = parseFloat(document.getElementById('propY').value);
    const width = parseFloat(document.getElementById('propWidth').value);
    const height = parseFloat(document.getElementById('propHeight').value);
    const rotation = parseFloat(document.getElementById('propRotation').value);
    
    // Update zone data
    zones[selectedZone].x = x;
    zones[selectedZone].y = y;
    zones[selectedZone].width = width;
    zones[selectedZone].height = height;
    zones[selectedZone].rotation = rotation;
    
    // Update visual element
    const zoneElement = document.getElementById(`zone-${selectedZone}`);
    zoneElement.style.left = x + 'px';
    zoneElement.style.top = y + 'px';
    zoneElement.style.width = width + 'px';
    zoneElement.style.height = height + 'px';
    zoneElement.style.transform = `rotate(${rotation}deg)`;
    
    // Save to server
    updateZonePosition(selectedZone);
    
    // Close modal
    bootstrap.Modal.getInstance(document.getElementById('zonePropertiesModal')).hide();
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Clear selection when clicking on empty space
document.addEventListener('click', function(e) {
    if (e.target.id === 'venueMap' || e.target.id === 'mapContainer') {
        clearSelection();
    }
});
</script>
{% endblock %}