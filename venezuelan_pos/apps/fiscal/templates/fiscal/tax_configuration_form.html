{% extends "fiscal/base.html" %}
{% load i18n %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1>{{ action }} {% trans "Tax Configuration" %}</h1>
                    {% if selected_event %}
                    <p class="text-muted mb-0">
                        <i class="fas fa-calendar-alt"></i> {% trans "For event" %}: 
                        <strong>{{ selected_event.name }}</strong>
                    </p>
                    {% endif %}
                </div>
                <div>
                    {% if selected_event %}
                    <a href="{% url 'events:event_detail' selected_event.id %}" class="btn btn-outline-info me-2">
                        <i class="fas fa-calendar-alt"></i> {% trans "Back to Event" %}
                    </a>
                    {% endif %}
                    <a href="{% url 'fiscal_web:tax_configurations_list' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> {% trans "Back to List" %}
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    {% if selected_event %}
    <div class="row mb-3">
        <div class="col-12">
            <div class="alert alert-info">
                <div class="d-flex align-items-center">
                    <i class="fas fa-info-circle fa-2x me-3"></i>
                    <div>
                        <h6 class="alert-heading mb-1">{% trans "Creating Event-Specific Tax" %}</h6>
                        <p class="mb-0">
                            {% trans "You are creating a tax configuration specifically for" %} 
                            <strong>{{ selected_event.name }}</strong>. 
                            {% trans "This tax will only apply to transactions for this event." %}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">{% trans "Tax Configuration Details" %}</h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                        {% endif %}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.name.id_for_label }}" class="form-label">
                                        {{ form.name.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.name }}
                                    {% if form.name.errors %}
                                    <div class="text-danger small">{{ form.name.errors }}</div>
                                    {% endif %}
                                    {% if form.name.help_text %}
                                    <div class="form-text">{{ form.name.help_text }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.tax_type.id_for_label }}" class="form-label">
                                        {{ form.tax_type.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.tax_type }}
                                    {% if form.tax_type.errors %}
                                    <div class="text-danger small">{{ form.tax_type.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.scope.id_for_label }}" class="form-label">
                                        {{ form.scope.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.scope }}
                                    {% if form.scope.errors %}
                                    <div class="text-danger small">{{ form.scope.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.event.id_for_label }}" class="form-label">
                                        {{ form.event.label }}
                                    </label>
                                    {{ form.event }}
                                    {% if form.event.errors %}
                                    <div class="text-danger small">{{ form.event.errors }}</div>
                                    {% endif %}
                                    <div class="form-text">{% trans "Required only for event-level taxes" %}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3" id="rate-field">
                                    <label for="{{ form.rate.id_for_label }}" class="form-label">
                                        {{ form.rate.label }}
                                    </label>
                                    {{ form.rate }}
                                    {% if form.rate.errors %}
                                    <div class="text-danger small">{{ form.rate.errors }}</div>
                                    {% endif %}
                                    {% if form.rate.help_text %}
                                    <div class="form-text">{{ form.rate.help_text }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3" id="fixed-amount-field">
                                    <label for="{{ form.fixed_amount.id_for_label }}" class="form-label">
                                        {{ form.fixed_amount.label }}
                                    </label>
                                    {{ form.fixed_amount }}
                                    {% if form.fixed_amount.errors %}
                                    <div class="text-danger small">{{ form.fixed_amount.errors }}</div>
                                    {% endif %}
                                    {% if form.fixed_amount.help_text %}
                                    <div class="form-text">{{ form.fixed_amount.help_text }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        

                        
                        <div class="mb-3">
                            <div class="form-check">
                                {{ form.is_active }}
                                <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                    {{ form.is_active.label }}
                                </label>
                            </div>
                            {% if form.is_active.errors %}
                            <div class="text-danger small">{{ form.is_active.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            {% if selected_event %}
                            <a href="{% url 'events:event_detail' selected_event.id %}" class="btn btn-secondary">
                                {% trans "Cancel" %}
                            </a>
                            {% else %}
                            <a href="{% url 'fiscal_web:tax_configurations_list' %}" class="btn btn-secondary">
                                {% trans "Cancel" %}
                            </a>
                            {% endif %}
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> {{ action }} {% trans "Tax Configuration" %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">{% trans "Tax Configuration Help" %}</h6>
                </div>
                <div class="card-body">
                    <h6>{% trans "Tax Types" %}</h6>
                    <ul class="small">
                        <li><strong>{% trans "Percentage" %}:</strong> {% trans "Tax calculated as percentage of base amount" %}</li>
                        <li><strong>{% trans "Fixed" %}:</strong> {% trans "Fixed amount regardless of base amount" %}</li>
                        <li><strong>{% trans "Compound" %}:</strong> {% trans "Tax on tax calculation" %}</li>
                    </ul>
                    
                    <h6 class="mt-3">{% trans "Scope" %}</h6>
                    <ul class="small">
                        <li><strong>{% trans "Tenant" %}:</strong> {% trans "Applies to all events in tenant" %}</li>
                        <li><strong>{% trans "Event" %}:</strong> {% trans "Applies only to specific event" %}</li>
                    </ul>
                    
                    <h6 class="mt-3">{% trans "Rate Examples" %}</h6>
                    <ul class="small">
                        <li>0.16 = 16%</li>
                        <li>0.08 = 8%</li>
                        <li>0.05 = 5%</li>
                    </ul>
                    
                    <h6 class="mt-3">{% trans "Tax Status" %}</h6>
                    <div class="small">
                        <div class="alert alert-info py-2">
                            <i class="fas fa-info-circle"></i>
                            {% trans "Taxes are permanent and always active when enabled. Use the 'Active' checkbox to enable or disable taxes as needed." %}
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">{% trans "Tax Calculator Preview" %}</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">{% trans "Test Amount" %}</label>
                        <input type="number" id="test-amount" class="form-control" value="100.00" step="0.01">
                    </div>
                    <div id="tax-preview" class="alert alert-info">
                        <small>{% trans "Enter tax details to see preview" %}</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const taxTypeField = document.getElementById('{{ form.tax_type.id_for_label }}');
    const rateField = document.getElementById('rate-field');
    const fixedAmountField = document.getElementById('fixed-amount-field');
    const scopeField = document.getElementById('{{ form.scope.id_for_label }}');
    const eventField = document.getElementById('{{ form.event.id_for_label }}').closest('.mb-3');
    
    function toggleFields() {
        const taxType = taxTypeField.value;
        const scope = scopeField.value;
        
        // Show/hide rate vs fixed amount fields
        if (taxType === 'FIXED') {
            rateField.style.display = 'none';
            fixedAmountField.style.display = 'block';
        } else {
            rateField.style.display = 'block';
            fixedAmountField.style.display = 'block';
        }
        
        // Show/hide event field based on scope
        if (scope === 'EVENT') {
            eventField.style.display = 'block';
        } else {
            eventField.style.display = 'none';
        }
        
        updatePreview();
    }
    
    function updatePreview() {
        const testAmount = parseFloat(document.getElementById('test-amount').value) || 0;
        const taxType = taxTypeField.value;
        const rate = parseFloat(document.getElementById('{{ form.rate.id_for_label }}').value) || 0;
        const fixedAmount = parseFloat(document.getElementById('{{ form.fixed_amount.id_for_label }}').value) || 0;
        
        let taxAmount = 0;
        let description = '';
        
        if (taxType === 'PERCENTAGE') {
            taxAmount = testAmount * rate;
            description = `${testAmount.toFixed(2)} Ã— ${(rate * 100).toFixed(2)}% = ${taxAmount.toFixed(2)}`;
        } else if (taxType === 'FIXED') {
            taxAmount = fixedAmount;
            description = `Fixed amount: ${taxAmount.toFixed(2)}`;
        } else if (taxType === 'COMPOUND') {
            const baseTax = testAmount * rate;
            const compoundTax = baseTax * rate;
            taxAmount = baseTax + compoundTax;
            description = `Base: ${baseTax.toFixed(2)} + Compound: ${compoundTax.toFixed(2)} = ${taxAmount.toFixed(2)}`;
        }
        
        const total = testAmount + taxAmount;
        
        document.getElementById('tax-preview').innerHTML = `
            <strong>{% trans "Preview" %}:</strong><br>
            <small>${description}</small><br>
            <strong>{% trans "Total" %}: ${total.toFixed(2)}</strong>
        `;
    }
    
    // Event listeners
    taxTypeField.addEventListener('change', toggleFields);
    scopeField.addEventListener('change', toggleFields);
    document.getElementById('{{ form.rate.id_for_label }}').addEventListener('input', updatePreview);
    document.getElementById('{{ form.fixed_amount.id_for_label }}').addEventListener('input', updatePreview);
    document.getElementById('test-amount').addEventListener('input', updatePreview);
    
    // Initial setup
    toggleFields();
});
</script>
{% endblock %}