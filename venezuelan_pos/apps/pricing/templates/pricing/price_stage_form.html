{% extends 'events/base.html' %}
{% load i18n %}

{% block title %}
    {% if stage %}
        {% trans "Edit Price Stage" %} - {{ stage.name }}
    {% else %}
        {% trans "Create Price Stage" %} - {{ event.name }}
    {% endif %} - Tiquemax
{% endblock %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item"><a href="{% url 'pricing_web:dashboard' %}">{% trans "Pricing" %}</a></li>
    <li class="breadcrumb-item"><a href="{% url 'events:event_detail' event_id=event.id %}">{{ event.name }}</a></li>
    <li class="breadcrumb-item"><a href="{% url 'pricing_web:price_stage_list' event_id=event.id %}">{% trans "Price Stages" %}</a></li>
    <li class="breadcrumb-item active">
        {% if stage %}{% trans "Edit" %}{% else %}{% trans "Create" %}{% endif %}
    </li>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="bi bi-{% if stage %}pencil{% else %}plus-circle{% endif %} me-2"></i>
                    {% if stage %}
                        {% trans "Edit Hybrid Price Stage" %}
                    {% else %}
                        {% trans "Create Hybrid Price Stage" %}
                    {% endif %}
                </h4>
                <p class="text-muted mb-0 mt-1">{{ event.name }}</p>
            </div>
            <div class="card-body">
                <form method="post" novalidate>
                    {% csrf_token %}
                    
                    <!-- Basic Information -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-info-circle me-2"></i>{% trans "Basic Information" %}
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-8">
                                    <label for="{{ form.name.id_for_label }}" class="form-label">
                                        {{ form.name.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.name }}
                                    {% if form.name.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.name.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">
                                        {% trans "Examples: Early Bird, Regular, Last Minute" %}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label for="{{ form.stage_order.id_for_label }}" class="form-label">
                                        {{ form.stage_order.label }}
                                    </label>
                                    {{ form.stage_order }}
                                    {% if form.stage_order.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.stage_order.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.description.id_for_label }}" class="form-label">
                                    {{ form.description.label }}
                                </label>
                                {{ form.description }}
                                {% if form.description.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.description.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Date Range Configuration -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-calendar-range me-2"></i>{% trans "Date Range Configuration" %}
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="{{ form.start_date.id_for_label }}" class="form-label">
                                        {{ form.start_date.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.start_date }}
                                    {% if form.start_date.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.start_date.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label for="{{ form.end_date.id_for_label }}" class="form-label">
                                        {{ form.end_date.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.end_date }}
                                    {% if form.end_date.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.end_date.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hybrid Pricing Configuration -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-gear me-2"></i>{% trans "Hybrid Pricing Configuration" %}
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Scope Configuration -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="{{ form.scope.id_for_label }}" class="form-label">
                                        {{ form.scope.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.scope }}
                                    {% if form.scope.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.scope.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">
                                        {% trans "Choose whether this stage applies to the entire event or specific zones" %}
                                    </div>
                                </div>
                                <div class="col-md-6" id="zoneSelectContainer" style="display: none;">
                                    <label for="{{ form.zone.id_for_label }}" class="form-label">
                                        {{ form.zone.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.zone }}
                                    {% if form.zone.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.zone.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">
                                        {% trans "Select the specific zone for this pricing stage" %}
                                    </div>
                                </div>
                            </div>

                            <!-- Pricing Modifier Configuration -->
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="{{ form.modifier_type.id_for_label }}" class="form-label">
                                        {{ form.modifier_type.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.modifier_type }}
                                    {% if form.modifier_type.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.modifier_type.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-4">
                                    <label for="{{ form.modifier_value.id_for_label }}" class="form-label">
                                        {{ form.modifier_value.label }} <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        {{ form.modifier_value }}
                                        <span class="input-group-text" id="modifierUnit">%</span>
                                    </div>
                                    {% if form.modifier_value.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.modifier_value.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">
                                        {% trans "Modifier value (percentage or fixed amount)" %}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">{% trans "Price Preview" %}</label>
                                    <div class="card bg-light">
                                        <div class="card-body py-2">
                                            <div id="pricePreview" class="text-center">
                                                <div class="small text-muted">{% trans "Enter modifier to see preview" %}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Quantity Limit Configuration -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="{{ form.quantity_limit.id_for_label }}" class="form-label">
                                        {{ form.quantity_limit.label }}
                                        <i class="bi bi-info-circle text-muted" title="{% trans 'Hybrid pricing: Stage will transition when either date expires OR quantity limit reached' %}"></i>
                                    </label>
                                    {{ form.quantity_limit }}
                                    {% if form.quantity_limit.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.quantity_limit.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">
                                        {% trans "Maximum tickets that can be sold at this stage (leave empty for no limit)" %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mt-4">
                                        {{ form.auto_transition }}
                                        <label class="form-check-label" for="{{ form.auto_transition.id_for_label }}">
                                            {{ form.auto_transition.label }}
                                        </label>
                                    </div>
                                    {% if form.auto_transition.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.auto_transition.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">
                                        {% trans "Automatically transition when date expires or quantity limit reached" %}
                                    </div>
                                </div>
                            </div>

                            <!-- Hybrid Pricing Info -->
                            <div class="alert alert-info">
                                <h6 class="alert-heading">
                                    <i class="bi bi-lightbulb me-2"></i>{% trans "Hybrid Pricing System" %}
                                </h6>
                                <p class="mb-0">
                                    {% trans "This stage will automatically transition to the next stage when EITHER the end date is reached OR the quantity limit is fulfilled, whichever comes first. This allows for dynamic pricing based on both time and demand." %}
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Status Configuration -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-toggle-on me-2"></i>{% trans "Status Configuration" %}
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="form-check">
                                {{ form.is_active }}
                                <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                    {{ form.is_active.label }}
                                </label>
                            </div>
                            {% if form.is_active.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.is_active.errors.0 }}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                {% trans "Only active price stages will be used for price calculations" %}
                            </div>
                        </div>
                    </div>

                    <!-- Form Errors -->
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                    {% endif %}

                    <!-- Actions -->
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'pricing_web:price_stage_list' event_id=event.id %}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> {% trans "Cancel" %}
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-{% if stage %}check{% else %}plus{% endif %}"></i>
                            {% if stage %}
                                {% trans "Update Price Stage" %}
                            {% else %}
                                {% trans "Create Price Stage" %}
                            {% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Help Card -->
        <div class="card mt-4">
            <div class="card-header">
                <i class="bi bi-info-circle me-2"></i>{% trans "Hybrid Price Stage Guidelines" %}
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>{% trans "Best Practices" %}</h6>
                        <ul class="small">
                            <li>{% trans "Use clear, descriptive names" %}</li>
                            <li>{% trans "Ensure date ranges don't overlap within same scope" %}</li>
                            <li>{% trans "Order stages chronologically" %}</li>
                            <li>{% trans "Set realistic quantity limits based on expected demand" %}</li>
                            <li>{% trans "Consider customer purchasing behavior patterns" %}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>{% trans "Hybrid Pricing Examples" %}</h6>
                        <ul class="small">
                            <li><strong>{% trans "Early Bird:" %}</strong> -15% discount, 100 tickets max</li>
                            <li><strong>{% trans "Regular:" %}</strong> 0% base price, 500 tickets max</li>
                            <li><strong>{% trans "Last Minute:" %}</strong> +25% surcharge, no limit</li>
                            <li><strong>{% trans "VIP Zone:" %}</strong> +50% premium, zone-specific</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const modifierValueInput = document.getElementById('{{ form.modifier_value.id_for_label }}');
    const modifierTypeSelect = document.getElementById('{{ form.modifier_type.id_for_label }}');
    const scopeSelect = document.getElementById('{{ form.scope.id_for_label }}');
    const zoneContainer = document.getElementById('zoneSelectContainer');
    const modifierUnit = document.getElementById('modifierUnit');
    const pricePreview = document.getElementById('pricePreview');
    
    // Sample base price for preview
    const sampleBasePrice = 100.00;
    
    // Handle scope changes (show/hide zone selection)
    function handleScopeChange() {
        const scope = scopeSelect.value;
        if (scope === 'zone') {
            zoneContainer.style.display = 'block';
            zoneContainer.querySelector('select').required = true;
        } else {
            zoneContainer.style.display = 'none';
            zoneContainer.querySelector('select').required = false;
        }
    }
    
    // Handle modifier type changes (update unit display)
    function handleModifierTypeChange() {
        const modifierType = modifierTypeSelect.value;
        if (modifierType === 'percentage') {
            modifierUnit.textContent = '%';
        } else {
            modifierUnit.textContent = '$';
        }
        updatePricePreview();
    }
    
    // Update price preview
    function updatePricePreview() {
        const modifierValue = parseFloat(modifierValueInput.value) || 0;
        const modifierType = modifierTypeSelect.value;
        
        let finalPrice;
        let modifierAmount;
        
        if (modifierType === 'percentage') {
            modifierAmount = sampleBasePrice * (modifierValue / 100);
            finalPrice = sampleBasePrice + modifierAmount;
        } else {
            modifierAmount = modifierValue;
            finalPrice = sampleBasePrice + modifierAmount;
        }
        
        const sign = modifierAmount >= 0 ? '+' : '';
        
        pricePreview.innerHTML = `
            <div class="small text-muted">{% trans "Example with $100 base price:" %}</div>
            <div class="h5 mb-0 text-primary">$${finalPrice.toFixed(2)}</div>
            <div class="small text-muted">(${sign}$${modifierAmount.toFixed(2)})</div>
        `;
    }
    
    // Event listeners
    scopeSelect.addEventListener('change', handleScopeChange);
    modifierTypeSelect.addEventListener('change', handleModifierTypeChange);
    modifierValueInput.addEventListener('input', updatePricePreview);
    
    // Initial setup
    handleScopeChange();
    handleModifierTypeChange();
    updatePricePreview();
    
    // Date validation
    const startDateInput = document.getElementById('{{ form.start_date.id_for_label }}');
    const endDateInput = document.getElementById('{{ form.end_date.id_for_label }}');
    
    function validateDates() {
        const startDate = new Date(startDateInput.value);
        const endDate = new Date(endDateInput.value);
        
        if (startDate && endDate && startDate >= endDate) {
            endDateInput.setCustomValidity('{% trans "End date must be after start date" %}');
        } else {
            endDateInput.setCustomValidity('');
        }
    }
    
    startDateInput.addEventListener('change', validateDates);
    endDateInput.addEventListener('change', validateDates);
    
    // Quantity limit validation
    const quantityLimitInput = document.getElementById('{{ form.quantity_limit.id_for_label }}');
    
    function validateQuantityLimit() {
        const quantityLimit = parseInt(quantityLimitInput.value);
        if (quantityLimit && quantityLimit <= 0) {
            quantityLimitInput.setCustomValidity('{% trans "Quantity limit must be positive" %}');
        } else {
            quantityLimitInput.setCustomValidity('');
        }
    }
    
    quantityLimitInput.addEventListener('input', validateQuantityLimit);
});
</script>
{% endblock %}