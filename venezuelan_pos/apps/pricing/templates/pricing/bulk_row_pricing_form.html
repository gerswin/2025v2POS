{% extends 'events/base.html' %}
{% load i18n %}

{% block title %}{% trans "Bulk Create Row Pricing" %} - {{ zone.name }} - Tiquemax{% endblock %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item"><a href="{% url 'pricing_web:dashboard' %}">{% trans "Pricing" %}</a></li>
    <li class="breadcrumb-item"><a href="{% url 'events:event_detail' event_id=zone.event.id %}">{{ zone.event.name }}</a></li>
    <li class="breadcrumb-item"><a href="{% url 'pricing_web:row_pricing_list' zone_id=zone.id %}">{{ zone.name }} - {% trans "Row Pricing" %}</a></li>
    <li class="breadcrumb-item active">{% trans "Bulk Create" %}</li>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="bi bi-plus-square me-2"></i>
                    {% trans "Bulk Create Row Pricing" %}
                </h4>
                <p class="text-muted mb-0 mt-1">{{ zone.event.name }} - {{ zone.name }}</p>
            </div>
            <div class="card-body">
                <form method="post" novalidate>
                    {% csrf_token %}
                    
                    <!-- Zone Information -->
                    <div class="alert alert-info">
                        <div class="row">
                            <div class="col-md-4">
                                <strong>{% trans "Zone Base Price:" %}</strong> ${{ zone.base_price }}
                            </div>
                            <div class="col-md-4">
                                <strong>{% trans "Total Rows:" %}</strong> {{ zone.rows }}
                            </div>
                            <div class="col-md-4">
                                <strong>{% trans "Seats per Row:" %}</strong> {{ zone.seats_per_row }}
                            </div>
                        </div>
                    </div>

                    <!-- Row Range Configuration -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="{{ form.start_row.id_for_label }}" class="form-label">
                                {{ form.start_row.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.start_row }}
                            {% if form.start_row.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.start_row.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.end_row.id_for_label }}" class="form-label">
                                {{ form.end_row.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.end_row }}
                            {% if form.end_row.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.end_row.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Pricing Configuration -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="{{ form.percentage_markup.id_for_label }}" class="form-label">
                                {{ form.percentage_markup.label }} <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                {{ form.percentage_markup }}
                                <span class="input-group-text">%</span>
                            </div>
                            {% if form.percentage_markup.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.percentage_markup.errors.0 }}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                {% trans "This markup will be applied to all rows in the range" %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.name_pattern.id_for_label }}" class="form-label">
                                {{ form.name_pattern.label }}
                            </label>
                            {{ form.name_pattern }}
                            {% if form.name_pattern.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.name_pattern.errors.0 }}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                {% trans "Use {row} to include row number. Example: 'Row {row}'" %}
                            </div>
                        </div>
                    </div>

                    <!-- Preview Section -->
                    <div class="card bg-light mb-4">
                        <div class="card-header">
                            <i class="bi bi-eye me-2"></i>{% trans "Preview" %}
                        </div>
                        <div class="card-body">
                            <div id="previewContainer">
                                <div class="text-center text-muted">
                                    <i class="bi bi-calculator display-4"></i>
                                    <p class="mt-2">{% trans "Enter row range and markup to see preview" %}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Form Errors -->
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                    {% endif %}

                    <!-- Actions -->
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'pricing_web:row_pricing_list' zone_id=zone.id %}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> {% trans "Cancel" %}
                        </a>
                        <button type="submit" class="btn btn-success" id="submitBtn" disabled>
                            <i class="bi bi-plus-square"></i> {% trans "Create Row Pricing" %}
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Help Card -->
        <div class="card mt-4">
            <div class="card-header">
                <i class="bi bi-info-circle me-2"></i>{% trans "Bulk Creation Guidelines" %}
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>{% trans "How It Works" %}</h6>
                        <ul class="small">
                            <li>{% trans "Select a range of rows to configure" %}</li>
                            <li>{% trans "Set a single markup percentage for all rows" %}</li>
                            <li>{% trans "Optionally use a naming pattern" %}</li>
                            <li>{% trans "All rows will be created as active" %}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>{% trans "Common Use Cases" %}</h6>
                        <ul class="small">
                            <li><strong>{% trans "VIP Section:" %}</strong> {% trans "Rows 1-5 with 50% markup" %}</li>
                            <li><strong>{% trans "Premium:" %}</strong> {% trans "Rows 6-12 with 25% markup" %}</li>
                            <li><strong>{% trans "Standard:" %}</strong> {% trans "Rows 13-20 with 0% markup" %}</li>
                            <li><strong>{% trans "Economy:" %}</strong> {% trans "Back rows with -10% markup" %}</li>
                        </ul>
                    </div>
                </div>
                <div class="alert alert-warning mt-3">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>{% trans "Note:" %}</strong> 
                    {% trans "This will only create pricing for rows that don't already have pricing configured." %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const startRowInput = document.getElementById('{{ form.start_row.id_for_label }}');
    const endRowInput = document.getElementById('{{ form.end_row.id_for_label }}');
    const markupInput = document.getElementById('{{ form.percentage_markup.id_for_label }}');
    const namePatternInput = document.getElementById('{{ form.name_pattern.id_for_label }}');
    const previewContainer = document.getElementById('previewContainer');
    const submitBtn = document.getElementById('submitBtn');
    
    const basePrice = parseFloat('{{ zone.base_price }}');
    const maxRows = {{ zone.rows }};
    
    function updatePreview() {
        const startRow = parseInt(startRowInput.value) || 0;
        const endRow = parseInt(endRowInput.value) || 0;
        const markup = parseFloat(markupInput.value) || 0;
        const namePattern = namePatternInput.value.trim();
        
        if (startRow < 1 || endRow < 1 || startRow > endRow || endRow > maxRows) {
            previewContainer.innerHTML = `
                <div class="text-center text-muted">
                    <i class="bi bi-exclamation-triangle display-4"></i>
                    <p class="mt-2">{% trans "Please enter a valid row range" %}</p>
                </div>
            `;
            submitBtn.disabled = true;
            return;
        }
        
        const rowCount = endRow - startRow + 1;
        const markupAmount = basePrice * (markup / 100);
        const finalPrice = basePrice + markupAmount;
        
        let previewHtml = `
            <div class="row mb-3">
                <div class="col-md-3 text-center">
                    <div class="h5 text-primary">${rowCount}</div>
                    <div class="small text-muted">{% trans "Rows to Create" %}</div>
                </div>
                <div class="col-md-3 text-center">
                    <div class="h5 text-info">$${basePrice.toFixed(2)}</div>
                    <div class="small text-muted">{% trans "Base Price" %}</div>
                </div>
                <div class="col-md-3 text-center">
                    <div class="h5 text-warning">+$${markupAmount.toFixed(2)}</div>
                    <div class="small text-muted">{% trans "Markup Amount" %}</div>
                </div>
                <div class="col-md-3 text-center">
                    <div class="h5 text-success">$${finalPrice.toFixed(2)}</div>
                    <div class="small text-muted">{% trans "Final Price" %}</div>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>{% trans "Row" %}</th>
                            <th>{% trans "Name" %}</th>
                            <th>{% trans "Markup" %}</th>
                            <th>{% trans "Price" %}</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        // Show first few rows and last few rows if there are many
        const showRows = [];
        if (rowCount <= 10) {
            for (let i = startRow; i <= endRow; i++) {
                showRows.push(i);
            }
        } else {
            // Show first 3, middle, and last 3
            for (let i = startRow; i <= Math.min(startRow + 2, endRow); i++) {
                showRows.push(i);
            }
            if (rowCount > 6) {
                showRows.push('...');
            }
            for (let i = Math.max(endRow - 2, startRow + 3); i <= endRow; i++) {
                showRows.push(i);
            }
        }
        
        showRows.forEach(row => {
            if (row === '...') {
                previewHtml += `
                    <tr>
                        <td colspan="4" class="text-center text-muted">
                            <i class="bi bi-three-dots"></i> ${rowCount - 6} {% trans "more rows" %}
                        </td>
                    </tr>
                `;
            } else {
                const rowName = namePattern ? namePattern.replace('{row}', row) : `{% trans "Row" %} ${row}`;
                previewHtml += `
                    <tr>
                        <td><span class="badge bg-secondary">${row}</span></td>
                        <td>${rowName}</td>
                        <td><span class="badge bg-primary">+${markup}%</span></td>
                        <td class="text-success">$${finalPrice.toFixed(2)}</td>
                    </tr>
                `;
            }
        });
        
        previewHtml += `
                    </tbody>
                </table>
            </div>
        `;
        
        previewContainer.innerHTML = previewHtml;
        submitBtn.disabled = false;
    }
    
    // Update preview on input changes
    [startRowInput, endRowInput, markupInput, namePatternInput].forEach(input => {
        input.addEventListener('input', updatePreview);
    });
    
    // Validation
    function validateInputs() {
        const startRow = parseInt(startRowInput.value);
        const endRow = parseInt(endRowInput.value);
        
        if (startRow && (startRow < 1 || startRow > maxRows)) {
            startRowInput.setCustomValidity(`{% trans "Start row must be between 1 and" %} ${maxRows}`);
        } else {
            startRowInput.setCustomValidity('');
        }
        
        if (endRow && (endRow < 1 || endRow > maxRows)) {
            endRowInput.setCustomValidity(`{% trans "End row must be between 1 and" %} ${maxRows}`);
        } else if (startRow && endRow && endRow < startRow) {
            endRowInput.setCustomValidity('{% trans "End row must be greater than or equal to start row" %}');
        } else {
            endRowInput.setCustomValidity('');
        }
    }
    
    startRowInput.addEventListener('input', validateInputs);
    endRowInput.addEventListener('input', validateInputs);
    
    // Initial preview update
    updatePreview();
});
</script>
{% endblock %}