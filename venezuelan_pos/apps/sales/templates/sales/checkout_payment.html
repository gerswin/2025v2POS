{% extends 'events/base.html' %}
{% load i18n static %}

{% block title %}{% trans "Payment Method" %} - Tiquemax{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'sales_web:dashboard' %}">{% trans "Sales" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'sales_web:shopping_cart' %}">{% trans "Cart" %}</a></li>
<li class="breadcrumb-item active">{% trans "Payment" %}</li>
{% endblock %}

{% block extra_css %}
<style>
.checkout-steps {
    background: linear-gradient(135deg, var(--primary-color), #0056b3);
    color: white;
    padding: 2rem;
    border-radius: 0.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.step {
    display: flex;
    align-items: center;
    position: relative;
    flex: 1;
}

.step::after {
    content: '';
    position: absolute;
    top: 20px;
    left: 60%;
    right: -40%;
    height: 2px;
    background: rgba(255, 255, 255, 0.3);
    z-index: 0;
}

.step:last-child::after {
    display: none;
}

.step.completed::after {
    background: var(--success-color);
}

.step-number {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-right: 1rem;
    transition: all 0.3s ease;
    z-index: 1;
    position: relative;
    border: 3px solid transparent;
}

.step.active .step-number {
    background-color: white;
    color: var(--primary-color);
    transform: scale(1.1);
    box-shadow: 0 0 0 4px rgba(255,255,255,0.3);
}

.step.completed .step-number {
    background-color: var(--success-color);
    color: white;
    border-color: white;
}

.step-content {
    flex: 1;
}

.step-title {
    font-weight: bold;
    margin-bottom: 0.25rem;
}

.step-description {
    font-size: 0.85rem;
    opacity: 0.9;
}

.payment-methods {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    padding: 2rem;
}

.payment-option-card {
    border: 2px solid #dee2e6;
    border-radius: 0.75rem;
    background-color: #fff;
    transition: all 0.3s ease;
    cursor: pointer;
}

.payment-option-card:hover {
    border-color: var(--primary-color);
    box-shadow: 0 6px 18px rgba(0, 91, 179, 0.15);
}

.payment-option-card input[type="radio"] {
    width: 1.2rem;
    height: 1.2rem;
}

.order-summary {
    position: sticky;
    top: 20px;
    background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
    border: 2px solid var(--success-color);
    box-shadow: 0 4px 16px rgba(40, 167, 69, 0.1);
}

.price-highlight {
    background: linear-gradient(135deg, var(--success-color), #1e7e34);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

@media (max-width: 768px) {
    .order-summary {
        position: static;
        margin-top: 2rem;
    }
    .checkout-steps {
        padding: 1rem;
        overflow-x: auto;
    }
    .checkout-steps .d-flex {
        min-width: 700px;
    }
    .step-number {
        width: 40px;
        height: 40px;
        margin-right: 0.5rem;
    }
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateX(5px); }
}

#payment-option-error {
    font-weight: 500;
}
</style>
{% endblock %}

{% block content %}
<div class="checkout-steps">
    <div class="d-flex">
        <div class="step completed">
            <div class="step-number"><i class="bi bi-check"></i></div>
            <div class="step-content">
                <div class="step-title">{% trans "Review & Customer" %}</div>
                <div class="step-description">{% trans "Customer selected" %}</div>
            </div>
        </div>
        <div class="step active">
            <div class="step-number">2</div>
            <div class="step-content">
                <div class="step-title">{% trans "Payment" %}</div>
                <div class="step-description">{% trans "Choose payment method" %}</div>
            </div>
        </div>
        <div class="step">
            <div class="step-number">3</div>
            <div class="step-content">
                <div class="step-title">{% trans "Confirmation" %}</div>
                <div class="step-description">{% trans "Review and complete" %}</div>
            </div>
        </div>
        <div class="step">
            <div class="step-number">4</div>
            <div class="step-content">
                <div class="step-title">{% trans "Complete" %}</div>
                <div class="step-description">{% trans "Tickets ready" %}</div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="payment-methods">
            <h4 class="mb-4">
                <i class="bi bi-credit-card"></i>
                {% trans "How do you want to collect this order?" %}
            </h4>

            {% if not has_payment_methods %}
            <div class="alert alert-warning">
                <i class="bi bi-info-circle"></i> {% trans "Add at least one payment method before completing the sale." %}
            </div>
            {% endif %}

            <div id="payment-option-error" class="alert alert-danger d-none mb-4" role="alert" style="animation: shake 0.5s;"></div>

            <div class="payment-option-card mb-4 p-3 {% if payment_pref.option|default:'full' != 'partial' %}border-primary shadow{% endif %}">
                <div class="d-flex">
                    <div class="form-check me-3 mt-1">
                        <input class="form-check-input" type="radio" name="payment_option" value="full" {% if payment_pref.option|default:'full' != 'partial' %}checked{% endif %}>
                    </div>
                    <div class="flex-grow-1">
                        <h5 class="mb-1">{% trans "Full Payment" %}</h5>
                        <p class="text-muted mb-2">{% trans "Charge the entire amount immediately." %}</p>
                        <div id="full-payment-section" class="mt-2">
                            <label for="full-payment-method" class="form-label">{% trans "Payment Method" %}</label>
                            <select id="full-payment-method" class="form-select" {% if not has_payment_methods %}disabled{% endif %}>
                                {% for method in payment_methods %}
                                    <option value="{{ method.id }}" {% if payment_pref.option|default:'full' != 'partial' and payment_pref.payment_method_id == method.id|stringformat:'s' %}selected{% endif %}>{{ method.name }}</option>
                                {% empty %}
                                    <option value="" disabled selected>{% trans "No payment methods configured" %}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted d-block mt-1">
                                <i class="bi bi-lightning text-success"></i> {% trans "Transaction will be completed and tickets delivered instantly." %}
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            {% if partial_payments_available %}
            <div class="payment-option-card mb-4 p-3 {% if payment_pref.option == 'partial' %}border-primary shadow{% endif %}">
                <div class="d-flex">
                    <div class="form-check me-3 mt-1">
                        <input class="form-check-input" type="radio" name="payment_option" value="partial" {% if payment_pref.option == 'partial' %}checked{% endif %}>
                    </div>
                    <div class="flex-grow-1">
                        <h5 class="mb-1">{% trans "Partial Payment Plan" %}</h5>
                        <p class="text-muted mb-2">{% trans "Take a deposit now and let the customer finish paying later." %}</p>

                        <div id="partial-payment-section" style="{% if payment_pref.option != 'partial' %}display:none;{% endif %}">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="id_plan_type" class="form-label">{% trans "Plan Type" %}</label>
                                    <select id="id_plan_type" class="form-select">
                                        <option value="installment" {% if payment_pref.plan_type|default:'installment' == 'installment' %}selected{% endif %}>{% trans "Installments" %}</option>
                                        <option value="flexible" {% if payment_pref.plan_type == 'flexible' %}selected{% endif %}>{% trans "Flexible Schedule" %}</option>
                                    </select>
                                    {% if not partial_payment_methods %}
                                    <small class="text-danger">{% trans "Add a payment method that allows partial payments." %}</small>
                                    {% endif %}
                                </div>
                                <div class="col-md-6" id="installment-count-wrapper" style="{% if payment_pref.plan_type == 'flexible' %}display:none;{% endif %}">
                                    <label for="id_installment_count" class="form-label">{% trans "Number of Installments" %}</label>
                                    <input id="id_installment_count" type="number" class="form-control" min="1" {% if max_installments %}max="{{ max_installments }}"{% endif %} value="{{ payment_pref.installment_count|default:max_installments|default:3 }}">
                                    {% if max_installments %}
                                        <small class="text-muted">{% blocktrans with count=max_installments %}Up to {{ count }} installments allowed{% endblocktrans %}</small>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="row g-3 mt-1">
                                <div class="col-md-6">
                                    <label for="id_initial_payment_amount" class="form-label">{% trans "Initial Payment" %}</label>
                                    <input id="id_initial_payment_amount" type="number" class="form-control" min="0" step="0.01" value="{{ payment_pref.initial_payment_amount|default:min_down_payment|floatformat:2|default:'0.00' }}">
                                    {% if min_down_payment and min_down_payment|floatformat:2 != '0.00' %}
                                        <small class="text-muted d-block mt-1">{% trans "Minimum deposit" %}: $<span id="minimum-deposit-value">{{ min_down_payment|floatformat:2 }}</span></small>
                                    {% else %}
                                        <small class="text-muted d-block mt-1">{% trans "Deposit is optional for this event." %}</small>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label for="partial-payment-method" class="form-label">{% trans "Deposit Method" %}</label>
                                    <select id="partial-payment-method" class="form-select" {% if not partial_payment_methods %}disabled{% endif %}>
                                        {% for method in partial_payment_methods %}
                                            <option value="{{ method.id }}" {% if payment_pref.payment_method_id == method.id|stringformat:'s' and payment_pref.option == 'partial' %}selected{% endif %}>{{ method.name }}</option>
                                        {% empty %}
                                            <option value="" disabled selected>{% trans "No payment methods available" %}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div id="installment-summary" class="alert alert-info mt-3" style="display:none;">
                                <i class="bi bi-calendar-event"></i>
                                <span id="installment-summary-text"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-warning">
                <i class="bi bi-info-circle"></i>
                {% trans "Partial payments are not available for this event." %}
            </div>
            {% endif %}

            <form id="payment-option-csrf" class="d-none">{% csrf_token %}</form>

            <div class="d-flex justify-content-between mt-4">
                <a href="{% url 'sales_web:checkout_customer' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> {% trans "Back" %}
                </a>
                <button type="button" class="btn btn-primary" onclick="submitPaymentOption()" {% if not has_payment_methods %}disabled{% endif %}>
                    <i class="bi bi-arrow-right"></i> {% trans "Continue to Confirmation" %}
                </button>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="order-summary">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-receipt"></i>
                    {% trans "Order Summary" %}
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span>{% trans "Tickets Selected" %}:</span>
                    <strong>{{ cart_count }}</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>{% trans "Customer" %}:</span>
                    <strong>{{ customer.full_name }}</strong>
                </div>
                <div class="d-flex justify-content-between mb-3">
                    <span>{% trans "Total Amount" %}:</span>
                    <strong class="price-highlight">${{ cart_total }}</strong>
                </div>
                {% if partial_payments_available %}
                <hr>
                <p class="small text-muted mb-2"><i class="bi bi-info-circle"></i> {% trans "Partial payment overview" %}</p>
                <div class="d-flex justify-content-between mb-1">
                    <span>{% trans "Minimum Deposit" %}:</span>
                    <strong>${{ min_down_payment|floatformat:2|default:'0.00' }}</strong>
                </div>
                {% if max_installments %}
                <div class="d-flex justify-content-between mb-1">
                    <span>{% trans "Max Installments" %}:</span>
                    <strong>{{ max_installments }}</strong>
                </div>
                {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.body.dataset.checkoutSubtotal = '{{ cart_subtotal|default:"0.00" }}';
document.body.dataset.checkoutTaxAmount = '{{ tax_amount|default:"0.00" }}';
document.body.dataset.checkoutTotal = '{{ cart_total_decimal|default:"0.00" }}';
document.body.dataset.checkoutMinDeposit = '{{ min_down_payment|default:"0.00" }}';
const hasPaymentMethods = {{ has_payment_methods|yesno:'true,false' }};
const paymentOptionEndpoint = '{% url "sales_web:checkout_payment_option" %}';
const checkoutConfirmUrl = '{% url "sales_web:checkout_confirm" %}';
</script>
<script src="{% static 'js/checkout_payment.js' %}"></script>
<script>
function getCsrfToken() {
    const csrfInput = document.querySelector('#payment-option-csrf input[name="csrfmiddlewaretoken"]');
    return csrfInput ? csrfInput.value : '';
}

function showPaymentError(message) {
    const errorBox = document.getElementById('payment-option-error');
    if (!errorBox) return;
    if (!message) {
        errorBox.classList.add('d-none');
        errorBox.textContent = '';
        return;
    }
    errorBox.innerHTML = `<i class="bi bi-exclamation-triangle-fill me-2"></i>${message}`;
    errorBox.classList.remove('d-none');

    // Trigger animation by removing and re-adding it
    errorBox.style.animation = 'none';
    setTimeout(() => {
        errorBox.style.animation = 'shake 0.5s';
    }, 10);

    // Scroll to error message
    errorBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

async function submitPaymentOption() {
    showPaymentError(null);
    const selectedOption = document.querySelector('input[name="payment_option"]:checked');
    if (!selectedOption) {
        showPaymentError('{% trans "Select how you want to process the payment." %}');
        return;
    }

    const payload = { option: selectedOption.value };

    if (selectedOption.value === 'full') {
        const methodSelect = document.getElementById('full-payment-method');
        if (!methodSelect || !methodSelect.value) {
            showPaymentError('{% trans "Choose a payment method for full payment." %}');
            return;
        }
        payload.payment_method_id = methodSelect.value;
    } else {
        const planType = document.getElementById('id_plan_type');
        const installmentsInput = document.getElementById('id_installment_count');
        const initialPaymentInput = document.getElementById('id_initial_payment_amount');
        const partialMethod = document.getElementById('partial-payment-method');

        if (!planType) {
            showPaymentError('{% trans "Select a plan type." %}');
            return;
        }

        payload.plan_type = planType.value;

        if (planType.value === 'installment') {
            if (!installmentsInput || !installmentsInput.value) {
                showPaymentError('{% trans "Enter the number of installments." %}');
                return;
            }
            payload.installment_count = installmentsInput.value;
        }

        if (!initialPaymentInput) {
            showPaymentError('{% trans "Provide the initial payment amount." %}');
            return;
        }
        payload.initial_payment_amount = initialPaymentInput.value || '0';

        if (!partialMethod || !partialMethod.value) {
            showPaymentError('{% trans "Choose a payment method for the deposit." %}');
            return;
        }
        payload.payment_method_id = partialMethod.value;
    }

    try {
        if (!hasPaymentMethods) {
            showPaymentError('{% trans "At least one payment method must be configured before continuing." %}');
            return;
        }
        const response = await fetch(paymentOptionEndpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            credentials: 'same-origin',
            body: JSON.stringify(payload)
        });

        const data = await response.json();
        if (!response.ok || !data.success) {
            showPaymentError(data.error || '{% trans "Unable to save payment preference." %}');
            return;
        }

        window.location.href = checkoutConfirmUrl;
    } catch (error) {
        showPaymentError('{% trans "Unexpected error saving the payment option." %}');
    }
}
</script>
{% endblock %}
