{% extends 'events/base.html' %}
{% load i18n %}

{% block title %}{% trans "Checkout" %} - Tiquemax{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'sales_web:dashboard' %}">{% trans "Sales" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'sales_web:shopping_cart' %}">{% trans "Cart" %}</a></li>
<li class="breadcrumb-item active">{% trans "Checkout" %}</li>
{% endblock %}

{% block extra_css %}
<style>
.checkout-steps {
    background: linear-gradient(135deg, var(--primary-color), #0056b3);
    color: white;
    padding: 2rem;
    border-radius: 0.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.step {
    display: flex;
    align-items: center;
    position: relative;
    flex: 1;
}

.step::after {
    content: '';
    position: absolute;
    top: 20px;
    left: 60%;
    right: -40%;
    height: 2px;
    background: rgba(255, 255, 255, 0.3);
    z-index: 0;
}

.step:last-child::after {
    display: none;
}

.step.completed::after {
    background: var(--success-color);
}

.step-number {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-right: 1rem;
    transition: all 0.3s ease;
    z-index: 1;
    position: relative;
    border: 3px solid transparent;
}

.step.active .step-number {
    background-color: white;
    color: var(--primary-color);
    transform: scale(1.1);
    box-shadow: 0 0 0 4px rgba(255,255,255,0.3);
}

.step.completed .step-number {
    background-color: var(--success-color);
    color: white;
    border-color: white;
}

.step-content {
    flex: 1;
}

.step-title {
    font-weight: bold;
    margin-bottom: 0.25rem;
}

.step-description {
    font-size: 0.85rem;
    opacity: 0.9;
}

.customer-selection {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    padding: 2rem;
}

.customer-card {
    border: 2px solid #dee2e6;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.customer-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(var(--primary-color-rgb), 0.1), transparent);
    transition: left 0.5s;
}

.customer-card:hover::before {
    left: 100%;
}

.customer-card:hover {
    border-color: var(--primary-color);
    transform: translateY(-2px) scale(1.01);
    box-shadow: 0 8px 16px rgba(0,0,0,0.15);
}

.customer-card.selected {
    border-color: var(--primary-color);
    background: linear-gradient(135deg, #e3f2fd 0%, #f0f8ff 100%);
    box-shadow: 0 4px 12px rgba(var(--primary-color-rgb), 0.2);
}

.customer-card.selected .form-check-input:checked {
    background-color: var(--success-color);
    border-color: var(--success-color);
}

.new-customer-form {
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 0.5rem;
    padding: 2rem;
    margin-top: 1rem;
}

.order-summary {
    position: sticky;
    top: 20px;
    background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
    border: 2px solid var(--success-color);
    box-shadow: 0 4px 16px rgba(40, 167, 69, 0.1);
}

.cart-item-summary {
    background: white;
    border-left: 4px solid var(--primary-color);
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 0.75rem;
    transition: all 0.2s ease;
}

.cart-item-summary:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transform: translateX(4px);
}

.cart-item-summary h6 {
    color: var(--primary-color);
    margin-bottom: 0.5rem;
}

.price-highlight {
    background: linear-gradient(135deg, var(--success-color), #1e7e34);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

@media (max-width: 768px) {
    .order-summary {
        position: static;
        margin-top: 2rem;
    }

    .checkout-steps {
        padding: 1rem;
        overflow-x: auto;
    }

    .checkout-steps .d-flex {
        min-width: 700px;
    }

    .step {
        font-size: 0.85rem;
    }

    .step-number {
        width: 40px;
        height: 40px;
        margin-right: 0.5rem;
    }

    .step::after {
        top: 16px;
    }

    .step-title {
        font-size: 0.9rem;
    }

    .step-description {
        font-size: 0.75rem;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Checkout Steps -->
<div class="checkout-steps">
    <div class="d-flex">
        <div class="step active">
            <div class="step-number">1</div>
            <div class="step-content">
                <div class="step-title">{% trans "Review & Customer" %}</div>
                <div class="step-description">{% trans "Select customer information" %}</div>
            </div>
        </div>
        <div class="step">
            <div class="step-number">2</div>
            <div class="step-content">
                <div class="step-title">{% trans "Payment" %}</div>
                <div class="step-description">{% trans "Choose payment method" %}</div>
            </div>
        </div>
        <div class="step">
            <div class="step-number">3</div>
            <div class="step-content">
                <div class="step-title">{% trans "Confirmation" %}</div>
                <div class="step-description">{% trans "Review and complete" %}</div>
            </div>
        </div>
        <div class="step">
            <div class="step-number">4</div>
            <div class="step-content">
                <div class="step-title">{% trans "Complete" %}</div>
                <div class="step-description">{% trans "Get your tickets" %}</div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Customer Selection -->
    <div class="col-md-8">
        <div class="customer-selection">
            <h4 class="mb-4">
                <i class="bi bi-person"></i>
                {% trans "Customer Information" %}
            </h4>
            
            <!-- Recent Customers -->
            {% if recent_customers %}
            <div class="mb-4">
                <h6>{% trans "Recent Customers" %}</h6>
                <div class="row">
                    {% for customer in recent_customers %}
                    <div class="col-md-6 mb-3">
                        <div class="card customer-card" 
                             data-customer-id="{{ customer.id }}"
                             onclick="selectCustomer(this)">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">{{ customer.full_name }}</h6>
                                        <small class="text-muted">
                                            {% if customer.email %}
                                                <i class="bi bi-envelope"></i> {{ customer.email }}
                                                <br>
                                            {% endif %}
                                            {% if customer.phone %}
                                                <i class="bi bi-phone"></i> {{ customer.phone }}
                                            {% endif %}
                                        </small>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" 
                                               name="customer_selection" 
                                               value="{{ customer.id }}">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- New Customer Option -->
            <div class="mb-3">
                <div class="card customer-card" 
                     data-customer-id="new"
                     onclick="selectCustomer(this)">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">
                                    <i class="bi bi-person-plus"></i>
                                    {% trans "New Customer" %}
                                </h6>
                                <small class="text-muted">{% trans "Enter new customer information" %}</small>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" 
                                       name="customer_selection" 
                                       value="new">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- New Customer Form (Hidden by default) -->
            <div id="newCustomerForm" class="new-customer-form d-none">
                <h6 class="mb-3">
                    <i class="bi bi-person-plus"></i>
                    {% trans "New Customer Information" %}
                </h6>
                <form id="customerForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="customerName" class="form-label">
                                {% trans "First Name" %} <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="customerName" 
                                   name="name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="customerSurname" class="form-label">
                                {% trans "Last Name" %} <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="customerSurname" 
                                   name="surname" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="customerPhone" class="form-label">
                                {% trans "Phone" %} <span class="text-danger">*</span>
                            </label>
                            <input type="tel" class="form-control" id="customerPhone" 
                                   name="phone" required 
                                   placeholder="+58 414 123 4567">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="customerEmail" class="form-label">
                                {% trans "Email" %}
                            </label>
                            <input type="email" class="form-control" id="customerEmail" 
                                   name="email" 
                                   placeholder="customer@example.com">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="customerIdentification" class="form-label">
                            {% trans "ID Number (Cédula)" %}
                        </label>
                        <input type="text" class="form-control" id="customerIdentification" 
                               name="identification" 
                               placeholder="V-12345678">
                    </div>
                </form>
            </div>
            
            <!-- Continue Button -->
            <div class="text-end mt-4">
                <button class="btn btn-primary btn-lg" 
                        id="continueBtn" 
                        onclick="proceedToPayment()"
                        disabled>
                    {% trans "Continue to Payment" %}
                    <i class="bi bi-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Order Summary -->
    <div class="col-md-4">
        <div class="card order-summary">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-receipt"></i>
                    {% trans "Order Summary" %}
                </h5>
            </div>
            <div class="card-body">
                <!-- Event Information -->
                {% if event %}
                <div class="event-info mb-3">
                    <h6 class="text-primary">{{ event.name }}</h6>
                    <small class="text-muted">
                        <i class="bi bi-building"></i> {{ event.venue.name }}
                        <br>
                        <i class="bi bi-calendar"></i> {{ event.start_date|date:"M d, Y H:i" }}
                    </small>
                </div>
                <hr>
                {% endif %}
                
                <!-- Cart Items -->
                <div class="cart-items mb-3">
                    {% for item in cart_items %}
                    <div class="cart-item-summary">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">{{ item.zone_name }}</h6>
                                {% if item.seat_label %}
                                    <small class="text-muted">{{ item.seat_label }}</small>
                                {% else %}
                                    <small class="text-muted">{{ item.quantity }} {% trans "tickets" %}</small>
                                {% endif %}
                                
                                {% if item.pricing_details.current_stage %}
                                <br>
                                <span class="badge bg-success">
                                    <i class="bi bi-tag"></i> {{ item.pricing_details.current_stage.name }}
                                </span>
                                {% endif %}
                            </div>
                            <div class="text-end">
                                <strong class="price-highlight fs-5">${{ item.total_price }}</strong>
                                {% if item.quantity > 1 %}
                                <br>
                                <small class="text-muted">
                                    <i class="bi bi-calculator"></i> ${{ item.unit_price }} × {{ item.quantity }}
                                </small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Totals -->
                <div class="totals">
                    <div class="d-flex justify-content-between mb-2">
                        <span>{% trans "Subtotal:" %}</span>
                        <span>${{ cart_total|floatformat:2 }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>{% trans "Taxes:" %}</span>
                        <span class="text-muted">{% trans "Calculated at payment" %}</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <strong class="fs-5">{% trans "Total:" %}</strong>
                        <strong class="text-success fs-3 price-highlight">${{ cart_total|floatformat:2 }}</strong>
                    </div>
                    <div class="alert alert-success mb-0" role="alert">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-tag-fill me-2"></i>
                            <small>{% trans "Best price guaranteed" %}</small>
                        </div>
                    </div>
                </div>

                <!-- Security Notice -->
                <div class="mt-3 p-3 bg-white border rounded">
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-shield-check text-success fs-5 me-2"></i>
                        <small class="text-success fw-bold">
                            {% trans "Secure checkout process" %}
                        </small>
                    </div>
                    <div class="d-flex align-items-center">
                        <i class="bi bi-clock text-warning fs-5 me-2"></i>
                        <small class="text-muted">
                            {% trans "Session expires in" %} <strong id="sessionTimer">15:00</strong>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedCustomerId = null;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize form validation
    const customerForm = document.getElementById('customerForm');
    if (customerForm) {
        customerForm.addEventListener('input', validateForm);
    }

    // Initialize session timer
    startSessionTimer(15); // 15 minutes
});

function selectCustomer(cardElement) {
    // Remove selection from all cards
    document.querySelectorAll('.customer-card').forEach(card => {
        card.classList.remove('selected');
        const radio = card.querySelector('input[type="radio"]');
        if (radio) radio.checked = false;
    });
    
    // Select current card
    cardElement.classList.add('selected');
    const radio = cardElement.querySelector('input[type="radio"]');
    if (radio) radio.checked = true;
    
    selectedCustomerId = cardElement.dataset.customerId;
    
    // Show/hide new customer form
    const newCustomerForm = document.getElementById('newCustomerForm');
    if (selectedCustomerId === 'new') {
        newCustomerForm.classList.remove('d-none');
    } else {
        newCustomerForm.classList.add('d-none');
    }
    
    validateForm();
}

function validateForm() {
    const continueBtn = document.getElementById('continueBtn');
    let isValid = false;
    
    if (selectedCustomerId && selectedCustomerId !== 'new') {
        // Existing customer selected
        isValid = true;
    } else if (selectedCustomerId === 'new') {
        // New customer - validate form
        const name = document.getElementById('customerName').value.trim();
        const surname = document.getElementById('customerSurname').value.trim();
        const phone = document.getElementById('customerPhone').value.trim();
        
        isValid = name && surname && phone;
    }
    
    continueBtn.disabled = !isValid;
}

function proceedToPayment() {
    if (!selectedCustomerId) {
        showMessage('Please select a customer', 'error');
        return;
    }
    
    const continueBtn = document.getElementById('continueBtn');
    const originalText = continueBtn.innerHTML;
    
    // Show loading
    continueBtn.disabled = true;
    continueBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
    
    // Prepare form data
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
    
    if (selectedCustomerId === 'new') {
        // New customer data
        formData.append('name', document.getElementById('customerName').value.trim());
        formData.append('surname', document.getElementById('customerSurname').value.trim());
        formData.append('phone', document.getElementById('customerPhone').value.trim());
        formData.append('email', document.getElementById('customerEmail').value.trim());
        formData.append('identification', document.getElementById('customerIdentification').value.trim());
    } else {
        // Existing customer
        formData.append('customer_id', selectedCustomerId);
    }
    
    // Submit to customer step
    fetch('{% url "sales_web:checkout_customer" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            window.location.href = '{% url "sales_web:checkout_payment" %}';
        } else {
            throw new Error('Server error');
        }
    })
    .catch(error => {
        showMessage('Error processing customer information', 'error');
        continueBtn.disabled = false;
        continueBtn.innerHTML = originalText;
    });
}

function showMessage(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const icon = type === 'success' ? 'check-circle' : 'exclamation-triangle';
    
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            <i class="bi bi-${icon}"></i> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // Insert at the top of the content
    const content = document.querySelector('.main-content');
    content.insertAdjacentHTML('afterbegin', alertHtml);
    
    // Auto-hide after 3 seconds
    setTimeout(() => {
        const alert = content.querySelector('.alert');
        if (alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }
    }, 3000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function startSessionTimer(minutes) {
    let timeLeft = minutes * 60; // Convert to seconds
    const timerElement = document.getElementById('sessionTimer');

    function updateTimer() {
        const mins = Math.floor(timeLeft / 60);
        const secs = timeLeft % 60;
        timerElement.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;

        // Change color when time is running out
        if (timeLeft <= 60) {
            timerElement.classList.add('text-danger');
            timerElement.classList.remove('text-warning');
        } else if (timeLeft <= 300) {
            timerElement.classList.add('text-warning');
        }

        if (timeLeft <= 0) {
            showMessage('{% trans "Session expired. Please start over." %}', 'error');
            setTimeout(() => {
                window.location.href = '{% url "sales_web:shopping_cart" %}';
            }, 2000);
        } else {
            timeLeft--;
            setTimeout(updateTimer, 1000);
        }
    }

    updateTimer();
}
</script>
{% endblock %}