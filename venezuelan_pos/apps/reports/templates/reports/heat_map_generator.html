{% extends "reports/base.html" %}
{% load static %}

{% block title %}Generador de Mapas de Calor - Venezuelan POS{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">Generador de Mapas de Calor</h1>
                    <p class="text-muted">Visualiza la popularidad y ocupación de asientos por zona</p>
                </div>
                <div>
                    <a href="{% url 'reports:dashboard' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Volver
                    </a>
                </div>
            </div>
        </div>
    </div>

    <form method="post" id="heatMapForm">
        {% csrf_token %}
        
        <div class="row">
            <!-- Configuration Panel -->
            <div class="col-md-4">
                <div class="filter-panel">
                    <h5 class="mb-3">
                        <i class="fas fa-cog text-primary"></i>
                        Configuración
                    </h5>

                    <!-- Zone Selection -->
                    <div class="mb-3">
                        <label for="{{ form.zone.id_for_label }}" class="form-label">
                            {{ form.zone.label }}
                            <span class="text-danger">*</span>
                        </label>
                        {{ form.zone }}
                        {% if form.zone.errors %}
                            <div class="text-danger small mt-1">
                                {{ form.zone.errors.0 }}
                            </div>
                        {% endif %}
                        <small class="form-text text-muted">
                            Solo zonas con asientos numerados pueden generar mapas de calor
                        </small>
                    </div>

                    <!-- Event Filter -->
                    <div class="mb-3">
                        <label for="{{ form.event.id_for_label }}" class="form-label">
                            {{ form.event.label }}
                        </label>
                        {{ form.event }}
                        {% if form.event.errors %}
                            <div class="text-danger small mt-1">
                                {{ form.event.errors.0 }}
                            </div>
                        {% endif %}
                        <small class="form-text text-muted">
                            Deja vacío para incluir todos los eventos
                        </small>
                    </div>

                    <!-- Display Options -->
                    <div class="mb-3">
                        <h6 class="mb-2">Opciones de Visualización</h6>
                        
                        <div class="form-check mb-2">
                            {{ form.show_prices }}
                            <label class="form-check-label" for="{{ form.show_prices.id_for_label }}">
                                {{ form.show_prices.label }}
                            </label>
                        </div>
                        
                        <div class="form-check mb-2">
                            {{ form.show_sales_count }}
                            <label class="form-check-label" for="{{ form.show_sales_count.id_for_label }}">
                                {{ form.show_sales_count.label }}
                            </label>
                        </div>
                    </div>

                    <!-- Color Scheme -->
                    <div class="mb-3">
                        <label for="{{ form.color_scheme.id_for_label }}" class="form-label">
                            {{ form.color_scheme.label }}
                        </label>
                        {{ form.color_scheme }}
                    </div>

                    <!-- Generate Button -->
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary" id="generateBtn">
                            <i class="fas fa-fire"></i> Generar Mapa de Calor
                        </button>
                    </div>
                </div>

                <!-- Zone Information -->
                <div class="filter-panel mt-3" id="zone-info" style="display: none;">
                    <h6 class="mb-3">
                        <i class="fas fa-info-circle text-info"></i>
                        Información de la Zona
                    </h6>
                    <div id="zone-details"></div>
                </div>
            </div>

            <!-- Heat Map Display -->
            <div class="col-md-8">
                <div class="heat-map-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">
                            <i class="fas fa-fire text-danger"></i>
                            Mapa de Calor de Ocupación
                        </h5>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="zoomHeatMap('in')">
                                <i class="fas fa-search-plus"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="zoomHeatMap('out')">
                                <i class="fas fa-search-minus"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="exportHeatMap()">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>

                    <div id="heat-map-display">
                        <div class="text-center py-5">
                            <i class="fas fa-fire fa-4x text-muted mb-3"></i>
                            <h4 class="text-muted">Selecciona una zona para generar el mapa de calor</h4>
                            <p class="text-muted">
                                Los mapas de calor muestran la popularidad de cada asiento basada en las ventas históricas.
                            </p>
                        </div>
                    </div>

                    <!-- Legend -->
                    <div class="heat-map-legend" id="heat-map-legend" style="display: none;">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #e8f5e8; border: 1px solid #4caf50;"></div>
                            <span>Disponible</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #fff3e0; border: 1px solid #ff9800;"></div>
                            <span>Reservado</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ffebee; border: 1px solid #f44336;"></div>
                            <span>Vendido</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: linear-gradient(to right, #4caf50, #ffeb3b, #f44336);"></div>
                            <span>Popularidad (Baja → Alta)</span>
                        </div>
                    </div>
                </div>

                <!-- Statistics Panel -->
                <div class="heat-map-container mt-3" id="statistics-panel" style="display: none;">
                    <h6 class="mb-3">
                        <i class="fas fa-chart-bar text-success"></i>
                        Estadísticas de la Zona
                    </h6>
                    <div id="zone-statistics"></div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Seat Details Modal -->
<div class="modal fade" id="seatDetailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalles del Asiento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="seat-details-content">
                <!-- Seat details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
let currentHeatMapData = null;
let zoomLevel = 1;

$(document).ready(function() {
    // Zone selection change handler
    $('#id_zone').change(function() {
        const zoneId = $(this).val();
        if (zoneId) {
            loadZoneInfo(zoneId);
        } else {
            $('#zone-info').hide();
        }
    });

    // Form submission
    $('#heatMapForm').submit(function(e) {
        e.preventDefault();
        generateHeatMap();
    });
});

function loadZoneInfo(zoneId) {
    $.get(`/api/v1/zones/${zoneId}/`)
        .done(function(zone) {
            const infoHtml = `
                <div class="row">
                    <div class="col-6">
                        <small class="text-muted">Capacidad</small>
                        <div class="fw-bold">${zone.capacity} asientos</div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Filas</small>
                        <div class="fw-bold">${zone.rows} filas</div>
                    </div>
                    <div class="col-6 mt-2">
                        <small class="text-muted">Precio Base</small>
                        <div class="fw-bold text-success">$${zone.base_price}</div>
                    </div>
                    <div class="col-6 mt-2">
                        <small class="text-muted">Estado</small>
                        <div class="fw-bold">
                            <span class="badge bg-${zone.status === 'active' ? 'success' : 'secondary'}">
                                ${zone.status === 'active' ? 'Activa' : 'Inactiva'}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted">Evento</small>
                    <div class="fw-bold">${zone.event_name}</div>
                </div>
            `;
            
            $('#zone-details').html(infoHtml);
            $('#zone-info').show();
        })
        .fail(function() {
            $('#zone-info').hide();
        });
}

function generateHeatMap() {
    const formData = {
        zone_id: $('#id_zone').val(),
        event_id: $('#id_event').val() || null,
        show_prices: $('#id_show_prices').is(':checked'),
        show_sales_count: $('#id_show_sales_count').is(':checked'),
        color_scheme: $('#id_color_scheme').val()
    };

    if (!formData.zone_id) {
        alert('Por favor selecciona una zona');
        return;
    }

    // Show loading
    $('#heat-map-display').html(`
        <div class="text-center py-5">
            <div class="loading-spinner mb-3"></div>
            <h4 class="text-muted">Generando mapa de calor...</h4>
            <p class="text-muted">Analizando datos de ocupación y popularidad</p>
        </div>
    `);

    $('#generateBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Generando...');

    // Make AJAX request to generate heat map
    $.get('{% url "reports:ajax_heat_map_data" %}', formData)
        .done(function(data) {
            currentHeatMapData = data;
            renderHeatMap(data, formData);
            showStatistics(data);
            $('#heat-map-legend').show();
            $('#statistics-panel').show();
        })
        .fail(function(xhr) {
            const error = xhr.responseJSON?.error || 'Error al generar el mapa de calor';
            $('#heat-map-display').html(`
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <h4 class="text-warning">Error</h4>
                    <p class="text-muted">${error}</p>
                    <button class="btn btn-primary" onclick="generateHeatMap()">
                        <i class="fas fa-redo"></i> Reintentar
                    </button>
                </div>
            `);
        })
        .always(function() {
            $('#generateBtn').prop('disabled', false).html('<i class="fas fa-fire"></i> Generar Mapa de Calor');
        });
}

function renderHeatMap(data, options) {
    if (data.error) {
        $('#heat-map-display').html(`
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                ${data.error}
            </div>
        `);
        return;
    }

    let html = `
        <div class="mb-3">
            <h6>${data.zone_name}</h6>
            ${data.event_name ? `<small class="text-muted">Evento: ${data.event_name}</small>` : ''}
        </div>
        <div class="heat-map-grid" style="transform: scale(${zoomLevel}); transform-origin: top left;">
    `;

    // Render seats row by row
    for (let row = 1; row <= data.rows; row++) {
        html += `<div class="heat-map-row mb-1">`;
        html += `<div class="row-label me-2" style="display: inline-block; width: 30px; text-align: center; font-weight: bold;">F${row}</div>`;
        
        const rowData = data.grid[row] || {};
        const seatNumbers = Object.keys(rowData).map(k => parseInt(k)).sort((a, b) => a - b);
        
        for (const seatNum of seatNumbers) {
            const seat = rowData[seatNum];
            const seatClass = getSeatClass(seat, options.color_scheme);
            const seatContent = getSeatContent(seat, options);
            
            html += `
                <div class="heat-map-seat ${seatClass}" 
                     data-row="${row}" 
                     data-seat="${seatNum}"
                     data-bs-toggle="tooltip"
                     title="${getSeatTooltip(seat, row, seatNum)}"
                     onclick="showSeatDetails(${row}, ${seatNum})">
                    ${seatContent}
                </div>
            `;
        }
        
        html += `</div>`;
    }

    html += `</div>`;
    
    $('#heat-map-display').html(html);
    
    // Initialize tooltips
    $('[data-bs-toggle="tooltip"]').tooltip();
}

function getSeatClass(seat, colorScheme) {
    let baseClass = `heat-map-seat ${seat.status}`;
    
    // Add popularity-based coloring
    if (seat.popularity_score > 0) {
        if (seat.popularity_score >= 80) baseClass += ' popularity-very-high';
        else if (seat.popularity_score >= 60) baseClass += ' popularity-high';
        else if (seat.popularity_score >= 40) baseClass += ' popularity-medium';
        else if (seat.popularity_score >= 20) baseClass += ' popularity-low';
        else baseClass += ' popularity-very-low';
    }
    
    return baseClass;
}

function getSeatContent(seat, options) {
    let content = '';
    
    if (options.show_sales_count && seat.sales_count > 0) {
        content = seat.sales_count.toString();
    } else if (options.show_prices) {
        content = '$' + seat.price.toFixed(0);
    } else {
        // Show seat number or status indicator
        content = seat.status === 'available' ? '○' : (seat.status === 'sold' ? '●' : '◐');
    }
    
    return content;
}

function getSeatTooltip(seat, row, seatNum) {
    return `Fila ${row}, Asiento ${seatNum}
Estado: ${seat.status}
Precio: $${seat.price.toFixed(2)}
Ventas: ${seat.sales_count}
Popularidad: ${seat.popularity_score.toFixed(1)}%
${seat.last_sold ? 'Última venta: ' + new Date(seat.last_sold).toLocaleDateString('es-VE') : ''}`;
}

function showSeatDetails(row, seatNum) {
    if (!currentHeatMapData || !currentHeatMapData.grid[row] || !currentHeatMapData.grid[row][seatNum]) {
        return;
    }
    
    const seat = currentHeatMapData.grid[row][seatNum];
    
    const detailsHtml = `
        <div class="row">
            <div class="col-md-6">
                <h6>Información del Asiento</h6>
                <ul class="list-unstyled">
                    <li><strong>Posición:</strong> Fila ${row}, Asiento ${seatNum}</li>
                    <li><strong>Estado:</strong> 
                        <span class="badge bg-${seat.status === 'available' ? 'success' : (seat.status === 'sold' ? 'danger' : 'warning')}">
                            ${seat.status}
                        </span>
                    </li>
                    <li><strong>Precio:</strong> $${seat.price.toFixed(2)}</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>Estadísticas de Ventas</h6>
                <ul class="list-unstyled">
                    <li><strong>Ventas totales:</strong> ${seat.sales_count}</li>
                    <li><strong>Ingresos generados:</strong> $${seat.total_revenue.toFixed(2)}</li>
                    <li><strong>Puntuación de popularidad:</strong> ${seat.popularity_score.toFixed(1)}%</li>
                    <li><strong>Nivel de demanda:</strong> 
                        <span class="badge bg-${getDemandLevelColor(seat.demand_level)}">
                            ${getDemandLevelText(seat.demand_level)}
                        </span>
                    </li>
                </ul>
            </div>
        </div>
        ${seat.last_sold ? `
            <div class="mt-3">
                <h6>Última Venta</h6>
                <p class="text-muted">${new Date(seat.last_sold).toLocaleString('es-VE')}</p>
            </div>
        ` : ''}
    `;
    
    $('#seat-details-content').html(detailsHtml);
    $('#seatDetailsModal').modal('show');
}

function showStatistics(data) {
    if (!data.summary) return;
    
    const summary = data.summary;
    const statsHtml = `
        <div class="row">
            <div class="col-md-3">
                <div class="text-center p-3 border rounded">
                    <div class="h4 text-primary">${summary.total_sold}</div>
                    <small class="text-muted">Asientos Vendidos</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center p-3 border rounded">
                    <div class="h4 text-success">$${summary.total_revenue.toFixed(0)}</div>
                    <small class="text-muted">Ingresos Totales</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center p-3 border rounded">
                    <div class="h4 text-info">${summary.fill_rate.toFixed(1)}%</div>
                    <small class="text-muted">Tasa de Ocupación</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center p-3 border rounded">
                    <div class="h4 text-warning">$${summary.average_price.toFixed(2)}</div>
                    <small class="text-muted">Precio Promedio</small>
                </div>
            </div>
        </div>
        
        ${summary.most_popular_row ? `
            <div class="row mt-3">
                <div class="col-md-6">
                    <div class="alert alert-success">
                        <strong>Fila más popular:</strong> Fila ${summary.most_popular_row}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="alert alert-info">
                        <strong>Fila menos popular:</strong> Fila ${summary.least_popular_row}
                    </div>
                </div>
            </div>
        ` : ''}
    `;
    
    $('#zone-statistics').html(statsHtml);
}

function getDemandLevelColor(level) {
    const colors = {
        'very_high': 'danger',
        'high': 'warning',
        'medium': 'info',
        'low': 'secondary',
        'very_low': 'light'
    };
    return colors[level] || 'secondary';
}

function getDemandLevelText(level) {
    const texts = {
        'very_high': 'Muy Alta',
        'high': 'Alta',
        'medium': 'Media',
        'low': 'Baja',
        'very_low': 'Muy Baja'
    };
    return texts[level] || 'Desconocida';
}

function zoomHeatMap(direction) {
    if (direction === 'in' && zoomLevel < 2) {
        zoomLevel += 0.2;
    } else if (direction === 'out' && zoomLevel > 0.5) {
        zoomLevel -= 0.2;
    }
    
    $('.heat-map-grid').css('transform', `scale(${zoomLevel})`);
}

function exportHeatMap() {
    if (!currentHeatMapData) {
        alert('No hay datos de mapa de calor para exportar');
        return;
    }
    
    // Implementation for exporting heat map
    alert('Función de exportación en desarrollo');
}
</script>

<style>
.heat-map-grid {
    transition: transform 0.3s ease;
}

.heat-map-row {
    white-space: nowrap;
}

.row-label {
    font-size: 12px;
    color: #666;
    vertical-align: middle;
}

.heat-map-seat.popularity-very-high {
    background: linear-gradient(135deg, #f44336, #d32f2f) !important;
    color: white !important;
}

.heat-map-seat.popularity-high {
    background: linear-gradient(135deg, #ff9800, #f57c00) !important;
    color: white !important;
}

.heat-map-seat.popularity-medium {
    background: linear-gradient(135deg, #ffeb3b, #fbc02d) !important;
    color: #333 !important;
}

.heat-map-seat.popularity-low {
    background: linear-gradient(135deg, #8bc34a, #689f38) !important;
    color: white !important;
}

.heat-map-seat.popularity-very-low {
    background: linear-gradient(135deg, #4caf50, #388e3c) !important;
    color: white !important;
}
</style>
{% endblock %}