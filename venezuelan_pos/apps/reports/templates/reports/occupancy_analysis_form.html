{% extends "reports/base.html" %}
{% load static %}

{% block title %}
    {% if analysis %}Editar Análisis{% else %}Nuevo Análisis de Ocupación{% endif %} - Venezuelan POS
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        {% if analysis %}
                            Editar Análisis: {{ analysis.name }}
                        {% else %}
                            Nuevo Análisis de Ocupación
                        {% endif %}
                    </h1>
                    <p class="text-muted">
                        {% if analysis %}
                            Modifica los parámetros del análisis existente
                        {% else %}
                            Configura los parámetros para generar un nuevo análisis de ocupación
                        {% endif %}
                    </p>
                </div>
                <div>
                    <a href="{% url 'reports:occupancy_analysis_list' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Volver
                    </a>
                </div>
            </div>
        </div>
    </div>

    <form method="post" id="analysisForm">
        {% csrf_token %}
        
        <div class="row">
            <!-- Form Fields -->
            <div class="col-md-8">
                <div class="chart-container">
                    <h5 class="mb-4">
                        <i class="fas fa-cog text-primary"></i>
                        Configuración del Análisis
                    </h5>

                    <!-- Basic Information -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="{{ form.name.id_for_label }}" class="form-label">
                                {{ form.name.label }}
                                <span class="text-danger">*</span>
                            </label>
                            {{ form.name }}
                            {% if form.name.errors %}
                                <div class="text-danger small mt-1">
                                    {{ form.name.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.analysis_type.id_for_label }}" class="form-label">
                                {{ form.analysis_type.label }}
                                <span class="text-danger">*</span>
                            </label>
                            {{ form.analysis_type }}
                            {% if form.analysis_type.errors %}
                                <div class="text-danger small mt-1">
                                    {{ form.analysis_type.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Analysis Period -->
                    <div class="mb-4">
                        <h6 class="mb-3">
                            <i class="fas fa-calendar-alt text-info"></i>
                            Período de Análisis
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="{{ form.analysis_period_days.id_for_label }}" class="form-label">
                                    {{ form.analysis_period_days.label }}
                                </label>
                                {{ form.analysis_period_days }}
                                {% if form.analysis_period_days.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ form.analysis_period_days.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    Número de días hacia atrás desde hoy para incluir en el análisis
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Period Presets -->
                        <div class="mt-3">
                            <small class="text-muted">Períodos comunes:</small>
                            <div class="btn-group ms-2" role="group">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPeriod(7)">
                                    7 días
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPeriod(30)">
                                    30 días
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPeriod(90)">
                                    90 días
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPeriod(365)">
                                    1 año
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="mb-4">
                        <h6 class="mb-3">
                            <i class="fas fa-filter text-warning"></i>
                            Filtros Específicos
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="{{ form.event.id_for_label }}" class="form-label">
                                    {{ form.event.label }}
                                </label>
                                {{ form.event }}
                                {% if form.event.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ form.event.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    Opcional: Analizar solo un evento específico
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.zone.id_for_label }}" class="form-label">
                                    {{ form.zone.label }}
                                </label>
                                {{ form.zone }}
                                {% if form.zone.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ form.zone.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    Opcional: Analizar solo una zona específica
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Form Errors -->
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                    {% endif %}

                    <!-- Submit Buttons -->
                    <div class="d-flex justify-content-end gap-2">
                        <a href="{% url 'reports:occupancy_analysis_list' %}" class="btn btn-secondary">
                            Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="fas fa-chart-area"></i>
                            {% if analysis %}Actualizar Análisis{% else %}Generar Análisis{% endif %}
                        </button>
                    </div>
                </div>
            </div>

            <!-- Preview Panel -->
            <div class="col-md-4">
                <div class="chart-container">
                    <h5 class="mb-3">
                        <i class="fas fa-eye text-success"></i>
                        Vista Previa
                    </h5>
                    
                    <div id="preview-content">
                        <div class="text-center py-4">
                            <i class="fas fa-chart-area fa-3x text-muted mb-3"></i>
                            <p class="text-muted">
                                Configura los parámetros del análisis para ver una vista previa
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Analysis Type Information -->
                <div class="chart-container mt-3">
                    <h6 class="mb-3">
                        <i class="fas fa-info-circle text-info"></i>
                        Información del Tipo de Análisis
                    </h6>
                    
                    <div id="analysis-type-info">
                        <div class="alert alert-info">
                            <small>
                                Selecciona un tipo de análisis para ver información específica sobre qué datos incluirá.
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="chart-container mt-3">
                    <h6 class="mb-3">
                        <i class="fas fa-tachometer-alt text-warning"></i>
                        Estadísticas Estimadas
                    </h6>
                    
                    <div id="quick-stats">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="border rounded p-2 mb-2">
                                    <div class="fw-bold text-primary" id="preview-events">-</div>
                                    <small class="text-muted">Eventos</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-2 mb-2">
                                    <div class="fw-bold text-success" id="preview-zones">-</div>
                                    <small class="text-muted">Zonas</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-2">
                                    <div class="fw-bold text-info" id="preview-occupancy">-</div>
                                    <small class="text-muted">Ocupación Avg</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-2">
                                    <div class="fw-bold text-warning" id="preview-capacity">-</div>
                                    <small class="text-muted">Capacidad</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analysis Features -->
                <div class="chart-container mt-3">
                    <h6 class="mb-3">
                        <i class="fas fa-list-check text-success"></i>
                        Características del Análisis
                    </h6>
                    
                    <div id="analysis-features">
                        <div class="list-group list-group-flush">
                            <div class="list-group-item d-flex align-items-center">
                                <i class="fas fa-chart-line text-primary me-2"></i>
                                <small>Tendencias de ocupación</small>
                            </div>
                            <div class="list-group-item d-flex align-items-center">
                                <i class="fas fa-map text-info me-2"></i>
                                <small>Mapas de calor por zona</small>
                            </div>
                            <div class="list-group-item d-flex align-items-center">
                                <i class="fas fa-clock text-warning me-2"></i>
                                <small>Análisis temporal</small>
                            </div>
                            <div class="list-group-item d-flex align-items-center">
                                <i class="fas fa-percentage text-success me-2"></i>
                                <small>Métricas de rendimiento</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
$(document).ready(function() {
    // Analysis type information
    const analysisTypeInfo = {
        'zone_performance': {
            title: 'Rendimiento por Zona',
            description: 'Analiza el rendimiento de ocupación de cada zona individualmente.',
            includes: ['Ocupación por zona', 'Comparación entre zonas', 'Tendencias temporales', 'Identificación de zonas populares']
        },
        'time_based': {
            title: 'Análisis Temporal',
            description: 'Examina patrones de ocupación a lo largo del tiempo.',
            includes: ['Ocupación por día/hora', 'Patrones estacionales', 'Picos de demanda', 'Tendencias históricas']
        },
        'event_comparison': {
            title: 'Comparación de Eventos',
            description: 'Compara la ocupación entre diferentes eventos.',
            includes: ['Ocupación por evento', 'Rendimiento relativo', 'Factores de éxito', 'Benchmarking']
        },
        'capacity_utilization': {
            title: 'Utilización de Capacidad',
            description: 'Analiza qué tan eficientemente se utiliza la capacidad disponible.',
            includes: ['Porcentaje de utilización', 'Capacidad desperdiciada', 'Optimización de aforo', 'Recomendaciones']
        },
        'revenue_correlation': {
            title: 'Correlación con Ingresos',
            description: 'Relaciona los patrones de ocupación con la generación de ingresos.',
            includes: ['Ocupación vs ingresos', 'Zonas más rentables', 'Optimización de precios', 'ROI por zona']
        }
    };

    // Update analysis type info when selection changes
    $('#id_analysis_type').change(function() {
        const selectedType = $(this).val();
        if (selectedType && analysisTypeInfo[selectedType]) {
            const info = analysisTypeInfo[selectedType];
            const html = `
                <div class="alert alert-info">
                    <h6 class="alert-heading">${info.title}</h6>
                    <p class="mb-2">${info.description}</p>
                    <hr>
                    <small><strong>Incluye:</strong></small>
                    <ul class="mb-0 mt-1">
                        ${info.includes.map(item => `<li><small>${item}</small></li>`).join('')}
                    </ul>
                </div>
            `;
            $('#analysis-type-info').html(html);
        } else {
            $('#analysis-type-info').html(`
                <div class="alert alert-info">
                    <small>Selecciona un tipo de análisis para ver información específica.</small>
                </div>
            `);
        }
        updatePreview();
    });

    // Update zones when event changes
    $('#id_event').change(function() {
        const eventId = $(this).val();
        if (eventId) {
            // Load zones for selected event
            $.get(`/api/v1/events/${eventId}/zones/`, function(data) {
                const zoneSelect = $('#id_zone');
                zoneSelect.empty();
                zoneSelect.append('<option value="">---------</option>');
                
                if (data.results) {
                    data.results.forEach(function(zone) {
                        zoneSelect.append(`<option value="${zone.id}">${zone.name}</option>`);
                    });
                }
            }).fail(function() {
                console.log('Error loading zones');
            });
        } else {
            $('#id_zone').empty().append('<option value="">---------</option>');
        }
        updatePreview();
    });

    // Update preview when form changes
    $('#analysisForm input, #analysisForm select').change(updatePreview);
    
    // Trigger initial update
    $('#id_analysis_type').trigger('change');

    // Form submission
    $('#analysisForm').submit(function(e) {
        const submitBtn = $('#submitBtn');
        submitBtn.prop('disabled', true);
        submitBtn.html('<i class="fas fa-spinner fa-spin"></i> Generando...');
    });
});

function setPeriod(days) {
    $('#id_analysis_period_days').val(days);
    updatePreview();
}

function updatePreview() {
    const formData = {
        analysis_type: $('#id_analysis_type').val(),
        analysis_period_days: $('#id_analysis_period_days').val(),
        event: $('#id_event').val(),
        zone: $('#id_zone').val()
    };

    // Show loading
    $('#preview-content').html(`
        <div class="text-center py-4">
            <div class="loading-spinner mb-2"></div>
            <p class="text-muted">Cargando vista previa...</p>
        </div>
    `);

    // Simulate preview data (in real implementation, make AJAX call)
    setTimeout(() => {
        const previewHtml = `
            <div class="mb-3">
                <h6>Configuración Actual:</h6>
                <ul class="list-unstyled small">
                    <li><strong>Tipo:</strong> ${$('#id_analysis_type option:selected').text()}</li>
                    ${formData.analysis_period_days ? `<li><strong>Período:</strong> ${formData.analysis_period_days} días</li>` : ''}
                    ${formData.event ? `<li><strong>Evento:</strong> ${$('#id_event option:selected').text()}</li>` : ''}
                    ${formData.zone ? `<li><strong>Zona:</strong> ${$('#id_zone option:selected').text()}</li>` : ''}
                </ul>
            </div>
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i>
                <small>Configuración válida. El análisis se generará con estos parámetros.</small>
            </div>
        `;
        
        $('#preview-content').html(previewHtml);
        
        // Update quick stats (simulated data)
        const period = parseInt(formData.analysis_period_days) || 30;
        $('#preview-events').text(Math.floor(Math.random() * Math.min(period / 7, 20)));
        $('#preview-zones').text(Math.floor(Math.random() * 15) + 1);
        $('#preview-occupancy').text((Math.random() * 100).toFixed(1) + '%');
        $('#preview-capacity').text(Math.floor(Math.random() * 5000) + 500);
    }, 1000);
}
</script>
{% endblock %}