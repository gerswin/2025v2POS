{% extends "reports/base.html" %}
{% load static %}

{% block title %}
    {% if report %}Editar Reporte{% else %}Nuevo Reporte de Ventas{% endif %} - Venezuelan POS
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        {% if report %}
                            Editar Reporte: {{ report.name }}
                        {% else %}
                            Nuevo Reporte de Ventas
                        {% endif %}
                    </h1>
                    <p class="text-muted">
                        {% if report %}
                            Modifica los parámetros del reporte existente
                        {% else %}
                            Configura los parámetros para generar un nuevo reporte
                        {% endif %}
                    </p>
                </div>
                <div>
                    <a href="{% url 'reports:sales_reports_list' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Volver
                    </a>
                </div>
            </div>
        </div>
    </div>

    <form method="post" id="reportForm">
        {% csrf_token %}
        
        <div class="row">
            <!-- Form Fields -->
            <div class="col-md-8">
                <div class="chart-container">
                    <h5 class="mb-4">
                        <i class="fas fa-cog text-primary"></i>
                        Configuración del Reporte
                    </h5>

                    <!-- Basic Information -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="{{ form.name.id_for_label }}" class="form-label">
                                {{ form.name.label }}
                                <span class="text-danger">*</span>
                            </label>
                            {{ form.name }}
                            {% if form.name.errors %}
                                <div class="text-danger small mt-1">
                                    {{ form.name.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.report_type.id_for_label }}" class="form-label">
                                {{ form.report_type.label }}
                                <span class="text-danger">*</span>
                            </label>
                            {{ form.report_type }}
                            {% if form.report_type.errors %}
                                <div class="text-danger small mt-1">
                                    {{ form.report_type.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Date Range -->
                    <div class="mb-4">
                        <h6 class="mb-3">
                            <i class="fas fa-calendar-alt text-info"></i>
                            Rango de Fechas
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="{{ form.start_date.id_for_label }}" class="form-label">
                                    {{ form.start_date.label }}
                                </label>
                                {{ form.start_date }}
                                {% if form.start_date.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ form.start_date.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.end_date.id_for_label }}" class="form-label">
                                    {{ form.end_date.label }}
                                </label>
                                {{ form.end_date }}
                                {% if form.end_date.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ form.end_date.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Quick Date Presets -->
                        <div class="mt-3">
                            <small class="text-muted">Presets rápidos:</small>
                            <div class="btn-group ms-2" role="group">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setDateRange('today')">
                                    Hoy
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setDateRange('week')">
                                    Esta Semana
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setDateRange('month')">
                                    Este Mes
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setDateRange('quarter')">
                                    Trimestre
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="mb-4">
                        <h6 class="mb-3">
                            <i class="fas fa-filter text-warning"></i>
                            Filtros Específicos
                        </h6>
                        <div class="row">
                            <div class="col-md-4">
                                <label for="{{ form.event.id_for_label }}" class="form-label">
                                    {{ form.event.label }}
                                </label>
                                {{ form.event }}
                                {% if form.event.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ form.event.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                <label for="{{ form.zone.id_for_label }}" class="form-label">
                                    {{ form.zone.label }}
                                </label>
                                {{ form.zone }}
                                {% if form.zone.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ form.zone.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                <label for="{{ form.operator.id_for_label }}" class="form-label">
                                    {{ form.operator.label }}
                                </label>
                                {{ form.operator }}
                                {% if form.operator.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ form.operator.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Form Errors -->
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                    {% endif %}

                    <!-- Submit Buttons -->
                    <div class="d-flex justify-content-end gap-2">
                        <a href="{% url 'reports:sales_reports_list' %}" class="btn btn-secondary">
                            Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="fas fa-chart-bar"></i>
                            {% if report %}Actualizar Reporte{% else %}Generar Reporte{% endif %}
                        </button>
                    </div>
                </div>
            </div>

            <!-- Preview Panel -->
            <div class="col-md-4">
                <div class="chart-container">
                    <h5 class="mb-3">
                        <i class="fas fa-eye text-success"></i>
                        Vista Previa
                    </h5>
                    
                    <div id="preview-content">
                        <div class="text-center py-4">
                            <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                            <p class="text-muted">
                                Configura los parámetros del reporte para ver una vista previa
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Report Type Information -->
                <div class="chart-container mt-3">
                    <h6 class="mb-3">
                        <i class="fas fa-info-circle text-info"></i>
                        Información del Tipo de Reporte
                    </h6>
                    
                    <div id="report-type-info">
                        <div class="alert alert-info">
                            <small>
                                Selecciona un tipo de reporte para ver información específica sobre qué datos incluirá.
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="chart-container mt-3">
                    <h6 class="mb-3">
                        <i class="fas fa-tachometer-alt text-warning"></i>
                        Estadísticas Rápidas
                    </h6>
                    
                    <div id="quick-stats">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="border rounded p-2 mb-2">
                                    <div class="fw-bold text-primary" id="preview-transactions">-</div>
                                    <small class="text-muted">Transacciones</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-2 mb-2">
                                    <div class="fw-bold text-success" id="preview-revenue">-</div>
                                    <small class="text-muted">Ingresos</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-2">
                                    <div class="fw-bold text-info" id="preview-tickets">-</div>
                                    <small class="text-muted">Tickets</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-2">
                                    <div class="fw-bold text-warning" id="preview-avg">-</div>
                                    <small class="text-muted">Promedio</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
$(document).ready(function() {
    // Report type information
    const reportTypeInfo = {
        'daily': {
            title: 'Reporte Diario',
            description: 'Incluye todas las transacciones del día seleccionado con desglose por horas.',
            includes: ['Ventas por hora', 'Métodos de pago', 'Operadores activos', 'Resumen de zonas']
        },
        'weekly': {
            title: 'Reporte Semanal',
            description: 'Análisis de ventas de la semana con tendencias diarias.',
            includes: ['Ventas por día', 'Comparación con semana anterior', 'Top eventos', 'Análisis de zonas']
        },
        'monthly': {
            title: 'Reporte Mensual',
            description: 'Resumen completo del mes con análisis detallado.',
            includes: ['Ventas por semana', 'Eventos del mes', 'Rendimiento de zonas', 'Análisis de operadores']
        },
        'custom': {
            title: 'Reporte Personalizado',
            description: 'Reporte flexible con el rango de fechas y filtros que especifiques.',
            includes: ['Datos del período seleccionado', 'Filtros aplicados', 'Métricas personalizadas']
        },
        'event': {
            title: 'Reporte por Evento',
            description: 'Análisis completo de un evento específico.',
            includes: ['Ventas por zona', 'Ocupación', 'Métodos de pago', 'Timeline de ventas']
        },
        'zone': {
            title: 'Reporte por Zona',
            description: 'Análisis detallado del rendimiento de una zona específica.',
            includes: ['Ocupación por asiento', 'Precios aplicados', 'Velocidad de ventas', 'Comparación con otras zonas']
        },
        'operator': {
            title: 'Reporte por Operador',
            description: 'Análisis del rendimiento de un operador específico.',
            includes: ['Ventas realizadas', 'Métodos de pago utilizados', 'Horarios de actividad', 'Comparación con otros operadores']
        }
    };

    // Update report type info when selection changes
    $('#id_report_type').change(function() {
        const selectedType = $(this).val();
        if (selectedType && reportTypeInfo[selectedType]) {
            const info = reportTypeInfo[selectedType];
            const html = `
                <div class="alert alert-info">
                    <h6 class="alert-heading">${info.title}</h6>
                    <p class="mb-2">${info.description}</p>
                    <hr>
                    <small><strong>Incluye:</strong></small>
                    <ul class="mb-0 mt-1">
                        ${info.includes.map(item => `<li><small>${item}</small></li>`).join('')}
                    </ul>
                </div>
            `;
            $('#report-type-info').html(html);
        } else {
            $('#report-type-info').html(`
                <div class="alert alert-info">
                    <small>Selecciona un tipo de reporte para ver información específica.</small>
                </div>
            `);
        }
        updatePreview();
    });

    // Update preview when form changes
    $('#reportForm input, #reportForm select').change(updatePreview);
    
    // Trigger initial update
    $('#id_report_type').trigger('change');

    // Form submission
    $('#reportForm').submit(function(e) {
        const submitBtn = $('#submitBtn');
        submitBtn.prop('disabled', true);
        submitBtn.html('<i class="fas fa-spinner fa-spin"></i> Generando...');
    });
});

function setDateRange(preset) {
    const now = new Date();
    let startDate, endDate;

    switch(preset) {
        case 'today':
            startDate = endDate = now;
            break;
        case 'week':
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - now.getDay());
            startDate = weekStart;
            endDate = now;
            break;
        case 'month':
            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            endDate = now;
            break;
        case 'quarter':
            const quarterStart = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);
            startDate = quarterStart;
            endDate = now;
            break;
    }

    // Format dates for datetime-local input
    const formatDateTime = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}T00:00`;
    };

    $('#id_start_date').val(formatDateTime(startDate));
    $('#id_end_date').val(formatDateTime(endDate));
    
    updatePreview();
}

function updatePreview() {
    const formData = {
        report_type: $('#id_report_type').val(),
        start_date: $('#id_start_date').val(),
        end_date: $('#id_end_date').val(),
        event: $('#id_event').val(),
        zone: $('#id_zone').val(),
        operator: $('#id_operator').val()
    };

    // Show loading
    $('#preview-content').html(`
        <div class="text-center py-4">
            <div class="loading-spinner mb-2"></div>
            <p class="text-muted">Cargando vista previa...</p>
        </div>
    `);

    // Simulate preview data (in real implementation, make AJAX call)
    setTimeout(() => {
        const previewHtml = `
            <div class="mb-3">
                <h6>Configuración Actual:</h6>
                <ul class="list-unstyled small">
                    <li><strong>Tipo:</strong> ${$('#id_report_type option:selected').text()}</li>
                    ${formData.start_date ? `<li><strong>Desde:</strong> ${new Date(formData.start_date).toLocaleDateString('es-VE')}</li>` : ''}
                    ${formData.end_date ? `<li><strong>Hasta:</strong> ${new Date(formData.end_date).toLocaleDateString('es-VE')}</li>` : ''}
                    ${formData.event ? `<li><strong>Evento:</strong> ${$('#id_event option:selected').text()}</li>` : ''}
                    ${formData.zone ? `<li><strong>Zona:</strong> ${$('#id_zone option:selected').text()}</li>` : ''}
                    ${formData.operator ? `<li><strong>Operador:</strong> ${$('#id_operator option:selected').text()}</li>` : ''}
                </ul>
            </div>
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i>
                <small>Configuración válida. El reporte se generará con estos parámetros.</small>
            </div>
        `;
        
        $('#preview-content').html(previewHtml);
        
        // Update quick stats (simulated data)
        $('#preview-transactions').text(Math.floor(Math.random() * 1000));
        $('#preview-revenue').text('$' + (Math.random() * 50000).toFixed(0));
        $('#preview-tickets').text(Math.floor(Math.random() * 5000));
        $('#preview-avg').text('$' + (Math.random() * 100).toFixed(2));
    }, 1000);
}
</script>
{% endblock %}